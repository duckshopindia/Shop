
<!DOCTYPE html>  
<html lang="en">  
<head>
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>DuckShop</title>  
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkR1Y2tTaG9wIiwKICAic2hvcnRfbmFtZSI6ICJEdWNrU2hvcCIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29xvciI6ICIjZmZmZmZmIiwKICAidGhlbWVfY29xvciI6ICIjMjg3NGYwIgp9">
    <link rel="preconnect" href="https://i.ibb.co">  
    <link rel="preconnect" href="https://fonts.googleapis.com">  
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>  
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Share+Tech+Mono&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />  

    <style>  
        /* =================================================================  
           ECOMMERCE-STYLE CSS  
           ================================================================= */  
          
        :root {  
            --theme-blue: #2874f0;  
            --theme-light-gray: #f1f3f6;  
            --theme-yellow: #ffe500;  
            --theme-orange: #ff6161;  
            --theme-green: #388e3c;  
            --theme-dark-green: #1e7e34;  
            --theme-text: #212121;  
            --theme-secondary-text: #878787;  
            --theme-price: #388e3c;  
            --theme-strike: #878787;  
            --theme-border: #e0e0e0;  
            --theme-card-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.2);  
            --theme-header-shadow: 0 1px 4px 0 rgba(0, 0, 0, 0.1);  
            --border-radius: 2px;  
            --transition-speed: 0.3s;  
            --star-color: #ffc107;  
            --offer-color: #ff6161;  
            --offer-gradient: linear-gradient(135deg, #ff6161, #ff8761);  
            --app-purple: #6a1b9a;   
            --wallet-color: #673ab7;
            --wallet-bg: #ede7f6;
            --card-gradient: linear-gradient(135deg, #5b247a 0%, #1bcedf 100%);
            
            /* About Page Specific Colors */
            --about-brand: #16a34a;
            --about-brand-dark: #0f7a37;
            --about-bg: #f8fafc;
        }  

        *, *::before, *::after {  
            box-sizing: border-box;  
            margin: 0;  
            padding: 0;  
        }  

        html { scroll-behavior: smooth; }  
        body { font-family: 'Roboto', 'Poppins', sans-serif; background-color: var(--theme-light-gray); color: var(--theme-text); line-height: 1.4; font-size: 14px; padding-bottom: 0; }  
        .container { max-width: 1100px; margin: 0 auto; padding: 0 1rem; }  

        img {  
            max-width: 100%;  
            height: auto;  
            display: block;  
            opacity: 0;  
            will-change: opacity;  
            transition: opacity 0.3s ease-in-out;  
        }  
          
        img.loaded { opacity: 1; }  

        /* FORCE IMAGE VISIBILITY FOR DYNAMIC CONTENT */
        .list-item img, 
        .order-item img, 
        .order-detail-card img,
        .fk-img-box img,
        .fk-order-img,
        .product-image { 
            opacity: 1 !important; 
        }  
        .swiper-slide img { opacity: 1 !important; }  

        /* PREMIUM SKELETON LOADING SYSTEM */
        .premium-skeleton-card {
            background-color: #fff;
            border-radius: 4px;
            border: 1px solid var(--theme-border);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .sk-animate {
            background: #f0f0f0;
            background: linear-gradient(90deg, #eff1f3 25%, #e2e2e2 37%, #eff1f3 63%);
            background-size: 400% 100%;
            animation: premium-shimmer 1.4s ease infinite;
            border-radius: 4px;
        }
        @keyframes premium-shimmer {
            0% { background-position: 100% 50%; }
            100% { background-position: 0 50%; }
        }
        .sk-image-box { width: 100%; height: 140px; margin-bottom: 5px; }
        .sk-line-title { height: 14px; width: 90%; margin-bottom: 2px; }
        .sk-line-subtitle { height: 10px; width: 60%; margin-bottom: 8px; }
        .sk-price-wrapper { display: flex; gap: 8px; align-items: center; }
        .sk-line-price { height: 16px; width: 40%; }
        .sk-line-cut { height: 12px; width: 25%; }
        .sk-circle-btn { position: absolute; bottom: 10px; right: 10px; width: 32px; height: 32px; border-radius: 50%; border: 2px solid white; }
        .skeleton { background: #e0e0e0; display: block; }  
        
        a { text-decoration: none; color: var(--theme-blue); transition: color var(--transition-speed); }  
        a:hover { color: #1c5bc9; }  
        .header { display: none !important; }  
          
        /* HOME HEADER */  
        .home-specific-header { background-color: #fff; padding: 0.75rem 1rem; color: var(--theme-text); position: sticky; top: 0; z-index: 999; box-shadow: var(--theme-header-shadow); display: flex; flex-direction: column; gap: 0.75rem; }  
        .home-top-bar { display: flex; justify-content: space-between; align-items: center; }  
        .home-menu-icon { font-size: 1.6rem; color: var(--theme-secondary-text); cursor: pointer; }  
        .home-app-name { font-size: 1.5rem; font-weight: 700; color: var(--theme-text); flex-grow: 1; text-align: center; }  
        .home-app-name span { color: var(--theme-green); }  
        .home-profile-icon a { font-size: 1.8rem; color: var(--theme-secondary-text); }  
        .home-search-trigger { background-color: var(--theme-light-gray); border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px 15px; display: flex; align-items: center; gap: 10px; color: var(--theme-secondary-text); cursor: pointer; width: 100%; }  
        .home-search-trigger i { font-size: 1.1rem; }  
          
        /* CATEGORY SCROLLER */  
        #home-category-scroller { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background-color: #fff; min-height: 90px; }  
        .home-category-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; text-align: center; cursor: pointer; color: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: transform 0.2s; position: relative; overflow: hidden; }  
        .home-category-item:hover { transform: translateY(-3px); }  
        .cat-fast-food { background: linear-gradient(135deg, #ff416c, #ff4b2b); }  
        .cat-grocery { background: linear-gradient(135deg, #11998e, #38ef7d); }  
        .home-category-item img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.8); background-color: white; z-index: 2; opacity: 1 !important; }  
        .home-category-item span { font-size: 1rem; font-weight: 600; white-space: nowrap; z-index: 2; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }  

        #home-page .page-content { padding: 1rem; }  
        #home-page .page-title, #categories-page .page-title, #favourites-page .page-title, #about-page .page-title { padding-top: 1rem; }  
          
        .products-for-you-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; margin-bottom: 1rem; border-bottom: 1px solid var(--theme-border); }  
        .products-for-you-header h2 { font-size: 1.2rem; font-weight: 600; }  

        /* SEARCH & SIDE MENU */  
        #search-page .search-header { display: flex; align-items: center; gap: 1rem; padding: 0.8rem 1rem; background-color: white; box-shadow: var(--theme-header-shadow); position: sticky; top: 0; z-index: 1000; }  
        #search-page .back-btn { font-size: 1.2rem; color: var(--theme-text); }  
        #search-page #actual-search-input { width: 100%; border: none; outline: none; font-size: 1rem; font-family: 'Poppins', sans-serif; }  
        #search-results-grid { padding: 1rem; }  

        .side-menu { position: fixed; top: 0; left: 0; width: 280px; max-width: 80%; height: 100%; background-color: #fff; z-index: 2000; transform: translateX(-100%); transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94); box-shadow: 0 0 15px rgba(0,0,0,0.2); display: flex; flex-direction: column; padding-top: 2rem; }  
        .side-menu.open { transform: translateX(0); }  
        .side-menu ul { list-style: none; padding: 0; margin: 0; }  
        .side-menu ul li a { display: flex; align-items: center; padding: 1rem 1.5rem; color: var(--theme-text); font-size: 1.1rem; font-weight: 500; text-decoration: none; transition: background-color 0.2s, color 0.2s; border-bottom: 1px solid var(--theme-light-gray); }  
        .side-menu ul li a i { margin-right: 1rem; width: 20px; text-align: center; }  
        .side-menu ul li a:hover, .side-menu ul li a.active { background-color: var(--theme-light-gray); color: var(--theme-blue); }  
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1999; opacity: 0; visibility: hidden; transition: opacity 0.35s ease-in-out, visibility 0.35s ease-in-out; }  
        .menu-overlay.active { opacity: 1; visibility: visible; }  

        .badge { position: absolute; top: -8px; right: -10px; background-color: var(--theme-blue); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; justify-content: center; align-items: center; font-weight: bold; }  
        .hamburger { display: none; cursor: pointer; font-size: 1.5rem; color: white; }  
          
        main { padding-bottom: 90px; min-height: calc(100vh - 250px); }  
        #home-page.active main { padding-top: 0; }  
        .page { display: none; }  
        .page.active { display: block; animation: fadeIn 0.5s; }  
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }  
          
        .page-title { text-align: center; margin-bottom: 1.5rem; font-size: 1.5rem; font-weight: 600; color: var(--theme-text); text-transform: uppercase; letter-spacing: 0.5px; }  
          
        /* PRODUCT DETAIL */  
        #product-detail-page { max-width: 900px; margin: 0 auto; background: white; padding: 1rem; border-radius: 4px; box-shadow: var(--theme-card-shadow); }  
        .product-detail-layout { display: grid; grid-template-columns: 1fr 1.2fr; gap: 2rem; margin-bottom: 2rem; }  
        .product-detail-image-container { width: 100%; background: #fff; border: 1px solid var(--theme-border); border-radius: 4px; overflow: hidden; position: relative; }  
        .product-swiper { width: 100%; height: 350px; }  
        .product-swiper .swiper-slide { display: flex; justify-content: center; align-items: center; background: #fff; }  
        .product-swiper .swiper-slide img { max-width: 100%; max-height: 100%; object-fit: contain; width: auto; height: auto; }  
        .product-swiper .swiper-pagination-bullet { background: #c2c2c2; opacity: 1; width: 6px; height: 6px; margin: 0 4px; }  
        .product-swiper .swiper-pagination-bullet-active { background: var(--theme-blue); }  
        .product-detail-info h1 { font-size: 1.4rem; margin-bottom: 0.5rem; line-height: 1.3; color: var(--theme-text); font-weight: 500; }  
        .product-detail-price { font-size: 1.8rem; color: var(--theme-text); font-weight: 600; margin-bottom: 0.5rem; }  
        .product-detail-price-container { display: flex; align-items: baseline; gap: 0.8rem; margin-bottom: 1rem; flex-wrap: wrap; }  
        .product-detail-price-original { text-decoration: line-through; color: var(--theme-strike); font-size: 1rem; }  
        .product-detail-discount-badge { color: var(--theme-green); font-size: 1rem; font-weight: 600; }  
        .product-detail-desc { margin-bottom: 1.5rem; color: var(--theme-secondary-text); line-height: 1.6; border-top: 1px solid #f0f0f0; padding-top: 1rem; }  
        .product-stock-status { font-weight: 600; margin-bottom: 1.5rem; font-size: 1rem; padding: 0.75rem; border-radius: 4px; text-align: center; }  
        .product-stock-status.stock-high { background-color: #e8f5e9; color: var(--theme-green); border: 1px dashed var(--theme-green); }  
        .product-stock-status.stock-low { background-color: #fff3e0; color: #f57c00; border: 1px dashed #f57c00; }  
        .product-stock-status.stock-out { background-color: #ffebee; color: var(--theme-orange); border: 1px dashed var(--theme-orange); }  
        #product-detail-actions .btn { width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 600; border-radius: 2px; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.2); }  
        .product-detail-secondary-actions { position: absolute; top: 10px; right: 10px; z-index: 10; display: flex; gap: 10px; }  
        .fav-btn-floating { width: 36px; height: 36px; border-radius: 50%; background: white; box-shadow: 0 1px 4px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #e0e0e0; color: #c2c2c2; transition: 0.2s; }  
        .fav-btn-floating:hover { transform: scale(1.1); }
        .fav-btn-floating.active { color: var(--theme-orange); }  
        .share-btn-floating { color: var(--theme-blue); }
        #product-detail-actions .btn:disabled { background-color: var(--theme-secondary-text); border-color: var(--theme-secondary-text); cursor: not-allowed; }  
        .btn-success { background-color: var(--theme-yellow); color: var(--theme-text); border: none; }  
        .btn-success:hover { background-color: #f0d500; }  
        .btn-primary { background-color: var(--theme-orange); border-color: var(--theme-orange); }  
        .btn-primary:hover { background-color: #ff5050; border-color: #ff5050; }  
        .reviews-section, .related-products-section { margin-top: 1rem; border-top: 10px solid var(--theme-light-gray); padding-top: 1.5rem; background: #fff; padding-bottom: 1rem; }  
        .reviews-section h2, .related-products-section h2 { margin-bottom: 1rem; font-size: 1.2rem; color: var(--theme-text); padding-left: 1rem; }  
        
        /* SHOP CLOSED MESSAGE STYLE */
        .shop-closed-message { background-color: #ffebee; color: var(--theme-orange); padding: 0.8rem; border: 1px dashed var(--theme-orange); border-radius: 4px; text-align: center; margin-bottom: 0.8rem; font-weight: 600; font-size: 0.95rem; }
          
        /* HOME BANNER STYLES */  
        #home-banner-container { margin-bottom: 1rem; border-radius: 0; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); background-color: white; position: relative; width: 100%; }  
        .home-banner-swiper { width: 100%; height: 100%; }  
        .home-banner-swiper .swiper-slide img { display: block; width: 100%; height: auto; max-height: 220px; object-fit: cover; }  

        .product-grid { display: grid; gap: 0.5rem; grid-template-columns: repeat(2, 1fr); padding: 0.5rem; background: #fff; }  
        @media (min-width: 768px) { .product-grid { grid-template-columns: repeat(3, 1fr); gap: 1rem; padding: 1rem; } }  
        @media (min-width: 992px) { .product-grid { grid-template-columns: repeat(4, 1fr); } }  

        .product-card { border: 1px solid var(--theme-border); border-radius: 4px; overflow: hidden; display: flex; flex-direction: column; cursor: pointer; position: relative; background: white; content-visibility: auto; padding: 0.5rem; }  
        .product-card:hover { box-shadow: 0 3px 6px rgba(0,0,0,0.1); }  
        .product-card.out-of-stock { opacity: 0.7; }  
        .product-stock-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); display: flex; justify-content: center; align-items: center; font-size: 1.2rem; font-weight: 700; color: var(--theme-orange); z-index: 2; pointer-events: none; }  
        .product-image { width: 100%; height: 140px; object-fit: contain; margin-bottom: 0.5rem; }  
        .product-info { display: flex; flex-direction: column; flex-grow: 1; }  
        .product-name { font-size: 14px; font-weight: 400; margin-bottom: 4px; color: #212121; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.4; height: 40px; }  
        .product-category { font-size: 0.75rem; color: var(--theme-secondary-text); margin-bottom: 0.25rem; }  
        .product-price { font-size: 1rem; font-weight: 600; color: var(--theme-text); }  
        .product-price-container { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.25rem; }  
        .product-price-original { text-decoration: line-through; color: var(--theme-strike); font-size: 0.8rem; }  
        .product-discount-badge { color: var(--theme-green); font-size: 0.75rem; font-weight: 600; }  
        .product-actions { display: flex; justify-content: flex-end; align-items: center; position: absolute; top: 5px; right: 5px; gap: 5px; }  
        .product-actions .icon-btn { background: white; border: 1px solid #e0e0e0; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; cursor: pointer; color: #c2c2c2; box-shadow: 0 1px 2px rgba(0,0,0,0.1); transition: 0.2s ease-in-out; }  
        .product-actions .icon-btn:hover { transform: scale(1.1); }
        .product-actions .icon-btn.active { color: var(--theme-orange); border-color: transparent; }  
        .product-actions .icon-btn.share-btn { color: var(--theme-blue); }
          
        .category-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; padding: 1.5rem; }  
        .category-card { border-radius: 4px; overflow: hidden; text-align: center; box-shadow: var(--theme-card-shadow); cursor: pointer; transition: transform 0.3s; position: relative; background: white; }  
        .category-card:hover { transform: translateY(-5px); box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2); }  
        .category-card img { width: 100%; height: 150px; object-fit: cover; }  
        .category-card-name { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(40, 116, 240, 0.8); color: white; padding: 0.5rem; font-weight: 500; font-size: 0.9rem; }  

        .list-container { max-width: 900px; margin: 1.5rem auto; background: white; padding: 1rem; border-radius: 4px; box-shadow: var(--theme-card-shadow); }  
        .list-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; border-bottom: 1px solid var(--theme-border); }  
        .wishlist-item-clickable { cursor: pointer; transition: background-color var(--transition-speed); }  
        .wishlist-item-clickable:hover { background-color: var(--theme-light-gray); }  
        .list-item img { width: 70px; height: 70px; object-fit: contain; border-radius: 4px; background: white; padding: 0.5rem; border: 1px solid var(--theme-border); opacity: 1 !important; }  
        .list-item-info { flex-grow: 1; }  
        .list-item-info h3 { font-size: 1rem; color: var(--theme-text); margin-bottom: 0.25rem; }  
        .list-item-actions { display: flex; align-items: center; gap: 0.8rem; }  
        .quantity-selector { display: flex; align-items: center; gap: 0.5rem; }  
        .quantity-selector input { width: 40px; text-align: center; border: 1px solid var(--theme-border); border-radius: 4px; padding: 0.25rem; }  
        .list-summary { margin-top: 1.5rem; text-align: right; font-size: 1.1rem; font-weight: 600; color: var(--theme-text); }  
        .list-summary button { margin-top: 1rem; }  
        .empty-list-message { text-align: center; font-size: 1.1rem; color: var(--theme-secondary-text); padding: 2rem 0; }  
          
        /* FLIPKART STYLE ORDERS & CART CSS */
        .fk-cart-container {
            background-color: #f1f3f6;
            min-height: 100vh;
            padding-bottom: 120px; /* Space for sticky footer */
        }
        
        .fk-cart-card {
            background: white;
            padding: 16px;
            margin-bottom: 2px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .fk-item-flex {
            display: flex;
            gap: 16px;
        }

        .fk-img-box {
            width: 80px;
            height: 80px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fk-img-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .fk-info-box {
            flex-grow: 1;
        }

        .fk-title {
            font-size: 14px;
            color: #212121;
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.4;
        }
        
        .fk-variant {
            color: #878787;
            font-size: 12px;
            margin-bottom: 6px;
        }
        
        .fk-seller {
            font-size: 12px;
            color: #878787;
            margin-bottom: 8px;
        }

        .fk-price-row {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }
        
        .fk-price-main {
            font-size: 18px;
            font-weight: 600;
            color: #212121;
        }
        
        .fk-price-old {
            font-size: 14px;
            color: #878787;
            text-decoration: line-through;
        }
        
        .fk-discount {
            font-size: 14px;
            color: #388e3c;
            font-weight: 500;
        }

        .fk-actions-row {
            display: flex;
            align-items: center;
            gap: 20px;
            padding-top: 10px;
        }

        .fk-qty-counter {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .fk-qty-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid #c2c2c2;
            background: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            cursor: pointer;
        }
        
        .fk-qty-val {
            width: 40px;
            text-align: center;
            border: 1px solid #c2c2c2;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 500;
        }

        .fk-action-btn {
            font-size: 14px;
            font-weight: 600;
            color: #212121;
            background: none;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
        }
        
        .fk-action-btn:hover { color: var(--theme-blue); }

        .fk-price-details {
            background: white;
            margin-top: 12px;
            padding: 16px;
            box-shadow: 0 1px 1px 0 rgba(0,0,0,0.05);
        }
        
        .fk-price-header {
            font-size: 16px;
            font-weight: 600;
            color: #878787;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
            margin-bottom: 12px;
            text-transform: uppercase;
        }
        
        .fk-price-row-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
            color: #212121;
        }
        
        .fk-price-row-detail.green {
            color: #388e3c;
        }
        
        .fk-total-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-top: 1px dashed #e0e0e0;
            border-bottom: 1px dashed #e0e0e0;
            font-size: 18px;
            font-weight: 600;
            margin: 12px 0;
        }
        
        .fk-savings-msg {
            color: #388e3c;
            font-weight: 500;
            font-size: 14px;
            padding-top: 8px;
        }
        
        .fk-safe-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            color: #878787;
            font-size: 12px;
            background: #f1f3f6;
            margin: 10px 0;
        }

        .fk-sticky-footer {
            position: fixed;
            bottom: 60px; /* Above nav bar */
            left: 0;
            width: 100%;
            background: white;
            border-top: 1px solid #f0f0f0;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .fk-place-order-btn {
            background: #fb641b;
            color: white;
            border: none;
            padding: 12px 24px;
            font-weight: 600;
            font-size: 14px;
            border-radius: 2px;
            text-transform: uppercase;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,.2);
            width: 50%;
        }

        /* CHECKOUT MULTI-STEP STYLES */
        .checkout-stepper {
            display: flex;
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            justify-content: space-between;
        }
        .step-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            font-weight: 500;
            color: #878787;
        }
        .step-item.active {
            color: var(--theme-blue);
        }
        .step-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #f0f0f0;
            color: #878787;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        .step-item.active .step-circle {
            background: var(--theme-blue);
            color: white;
        }
        .step-line {
            flex-grow: 1;
            height: 1px;
            background: #e0e0e0;
            margin: 0 10px;
            align-self: center;
        }

        /* ORDER PAGE FLIPKART STYLE */
        .fk-order-search {
            padding: 10px;
            background: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            position: sticky;
            top: 55px;
            z-index: 900;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .fk-order-search input {
            width: 100%;
            border: 1px solid #f0f0f0;
            background: #f1f3f6;
            padding: 8px 12px;
            border-radius: 2px;
            font-size: 14px;
        }

        .fk-order-card {
            background: white;
            padding: 12px;
            margin-top: 8px;
            display: flex;
            gap: 12px;
            cursor: pointer;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
            transition: background 0.2s;
        }
        
        .fk-order-card:hover { background: #f9f9f9; }
        
        .fk-order-img {
            width: 60px;
            height: 60px;
            flex-shrink: 0;
            object-fit: contain;
        }
        
        .fk-order-info { flex-grow: 1; }
        
        .fk-order-title {
            font-weight: 500;
            font-size: 14px;
            color: #212121;
            margin-bottom: 4px;
        }
        
        .fk-order-status {
            font-size: 12px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-dot.green { background: #388e3c; }
        .status-dot.orange { background: #ff9f00; }
        .status-dot.red { background: #ff6161; }

        .order-detail-card { background: white; padding: 1.5rem; border-radius: 4px; box-shadow: var(--theme-card-shadow); margin-bottom: 1rem; }  
        .order-detail-header { border-bottom: 1px solid var(--theme-border); padding-bottom: 1rem; margin-bottom: 1rem; }  
        .order-detail-header h2 { font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; }  
        .order-detail-header p { color: var(--theme-secondary-text); font-size: 0.9rem; }  

        .status-tracker { display: flex; justify-content: space-between; position: relative; margin: 2.5rem 0; }  
        .status-tracker::before { content: ''; position: absolute; top: 20px; left: 16.67%; right: 16.67%; height: 4px; background-color: var(--theme-border); z-index: 1; transform: translateY(-50%); }  
        .status-step { display: flex; flex-direction: column; align-items: center; text-align: center; z-index: 2; position: relative; width: 33.33%; }  
        .status-step-icon { width: 40px; height: 40px; border-radius: 50%; background-color: var(--theme-border); color: white; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; transition: background-color 0.3s; margin-bottom: 0.5rem; border: 4px solid var(--theme-light-gray); }  
        .status-step-label { font-size: 0.8rem; font-weight: 500; color: var(--theme-secondary-text); }  
        .status-step.completed .status-step-icon { background-color: var(--theme-green); }  
        .status-step.completed .status-step-label { color: var(--theme-text); }  
        .status-line { position: absolute; top: 20px; left: 16.67%; height: 4px; background-color: var(--theme-green); z-index: 1; transform: translateY(-50%); transition: width 0.5s; }  
          
        .order-detail-summary .cart-summary-item,  
        .order-detail-summary .discount-applied { font-size: 1rem; }  
        .no-return-notice { background-color: #fff3e0; color: #f57c00; border: 1px dashed #f57c00; border-radius: 4px; padding: 1rem; text-align: center; font-weight: 500; margin-top: 1rem; }  

        .form-container, .static-content { max-width: 700px; margin: 1.5rem auto; padding: 1.5rem; border: 1px solid var(--theme-border); border-radius: 4px; background-color: #fff; box-shadow: var(--theme-card-shadow); }  
        .form-group { margin-bottom: 1.2rem; }  
        .form-group label { display: block; margin-bottom: 0.4rem; font-weight: 500; color: var(--theme-text); }  
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.6rem; border: 1px solid var(--theme-border); border-radius: 4px; font-size: 0.9rem; font-family: 'Poppins', sans-serif; }  
        .form-group textarea { resize: vertical; min-height: 100px; }  
        .form-group input[readonly] { background-color: #e9ecef; cursor: not-allowed; }  

        .btn { display: inline-block; padding: 0.6rem 1.2rem; font-size: 0.9rem; font-weight: 500; text-align: center; border-radius: 4px; cursor: pointer; transition: all var(--transition-speed); border: 1px solid transparent; position: relative; overflow: hidden; z-index: 1; }  
        .btn-primary { background-color: var(--theme-blue); color: white; border-color: var(--theme-blue); }  
        .btn-primary:hover { background-color: #1c5bc9; border-color: #1c5bc9; }  
        .btn-outline { background-color: transparent; color: var(--theme-blue); border-color: var(--theme-blue); }  
        .btn-outline:hover { background-color: var(--theme-blue); color: white; }  
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }  
        .btn-danger { background: none; border: none; color: var(--theme-orange); cursor: pointer; font-size: 1.1rem; }  
        .btn-outline-danger { color: var(--theme-orange); border-color: var(--theme-orange); background-color: transparent; }  
        .btn-outline-danger:hover { color: white; background-color: var(--theme-orange); }  
        .btn:disabled { background-color: var(--theme-secondary-text); border-color: var(--theme-secondary-text); cursor: not-allowed !important; }  

        .text-right { text-align: right; }   
        .text-center { text-align: center; }   
        .mt-2 { margin-top: 1rem; }   
        .mt-1 { margin-top: 0.8rem; }   
        .d-none { display: none !important; }  

        .discount-section { margin-top: 1.2rem; padding-top: 1.2rem; border-top: 1px dashed var(--theme-border); }  
        .discount-form { display: flex; gap: 0.5rem; margin-bottom: 0.8rem; }  
        .discount-form input { flex-grow: 1; padding: 0.6rem; border: 1px solid var(--theme-border); border-radius: 4px; font-size: 0.9rem; }  
        .discount-form button { padding: 0.6rem 1.2rem; }  
        .cart-summary-item { display: flex; justify-content: space-between; margin-bottom: 0.4rem; color: var(--theme-text); }  
        .cart-summary-item.total { margin-top: 0.8rem; padding-top: 0.8rem; border-top: 2px solid var(--theme-border); font-weight: bold; font-size: 1.2rem; }  
        .discount-applied { display: flex; justify-content: space-between; background-color: #e8f5e9; padding: 0.6rem; border-radius: 4px; margin-bottom: 0.4rem; color: var(--theme-text); }  
        .remove-discount { background: none; border: none; color: var(--theme-orange); cursor: pointer; font-weight: 500; }  

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity var(--transition-speed), visibility var(--transition-speed); z-index: 2000; overflow-y: auto; padding: 1rem; }  
        .modal.open { opacity: 1; visibility: visible; }  
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 4px; width: 90%; max-width: 450px; transform: scale(0.95); transition: transform var(--transition-speed); position: relative; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }  
        .modal.open .modal-content { transform: scale(1); }  
        .close-modal-btn { position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; background: none; border: none; cursor: pointer; color: var(--theme-secondary-text); }  

        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); padding: 0.8rem 1.5rem; border-radius: 4px; color: white; font-weight: 500; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); opacity: 0; visibility: hidden; transition: opacity 0.3s, transform 0.3s, visibility 0.3s; z-index: 3000; text-align: center; width: 90%; max-width: 400px; }  
        .toast.show { opacity: 1; visibility: visible; transform: translate(-50%, -10px); }  
        .toast.success { background-color: var(--theme-green); }  
        .toast.error { background-color: var(--theme-orange); }  
        .toast.notification { background-color: #333; cursor: pointer; }
          
        .footer { background-color: var(--theme-light-gray); padding: 1.5rem 0; margin-top: 3rem; text-align: center; border-top: 1px solid var(--theme-border); }  
        .social-links { display: flex; justify-content: center; gap: 1.2rem; margin-bottom: 0.8rem; }  
        .social-links a { font-size: 1.5rem; color: var(--theme-secondary-text); transition: color 0.3s, transform 0.3s; }  
        .social-links a:hover { color: var(--theme-blue); transform: translateY(-3px); }  
        .footer p { color: var(--theme-secondary-text); font-size: 0.8rem; }  
          
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #fff; border-top: 1px solid var(--theme-border); box-shadow: 0 -2px 8px rgba(0,0,0,0.08); display: flex; justify-content: space-around; z-index: 1001; padding: 0.4rem 0; }  
        .bottom-nav a { flex-grow: 1; text-align: center; padding: 0.5rem 0.4rem; color: var(--theme-secondary-text); display: flex; flex-direction: column; align-items: center; gap: 3px; font-size: 0.7rem; font-weight: 500; }  
        .bottom-nav a i { font-size: 1.1rem; }  
        .bottom-nav a.active { color: var(--theme-blue); }  
        .bottom-nav .cart-badge { display: none !important; position: absolute; top: 2px; right: 50%; transform: translateX(50%); background-color: var(--theme-orange); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; justify-content: center; align-items: center; font-weight: bold; margin-right: -25px; }  

        .payment-method { border: 1px solid var(--theme-border); border-radius: 4px; padding: 1rem; margin-bottom: 1rem; background: white; cursor: pointer; transition: all var(--transition-speed); }  
        .payment-method.selected { border-color: var(--theme-blue); background-color: #f0f7ff; } 
        .payment-method.disabled { opacity: 0.5; cursor: not-allowed; background-color: #eee; border-color: #ccc; pointer-events: none; }
        .payment-method-header { display: flex; align-items: center; gap: 1rem; }  
        .payment-method-icon { font-size: 1.5rem; color: var(--theme-secondary-text); }  
        .payment-method.selected .payment-method-icon { color: var(--theme-blue); }
        .payment-method-info { flex-grow: 1; }  
        .payment-method-name { font-weight: 600; margin-bottom: 0.25rem; }  
        .payment-method-desc { color: var(--theme-secondary-text); font-size: 0.9rem; }  
        .payment-method-check { color: var(--theme-blue); font-size: 1.2rem; display: none; } 
        .payment-method.selected .payment-method-check { display: block; }
          
        .auth-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(135deg, var(--app-purple), var(--theme-blue)); padding: 2rem 1rem; z-index: 1500; }  
        .page.auth-page { display: none; }  
        .page.auth-page.active { display: flex; }  
        .auth-container { width: 100%; max-width: 400px; background-color: #fff; padding: 2rem 2.5rem; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); text-align: center; animation: fadeIn 0.5s ease-out; }  
        .auth-header .home-app-name { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; }  
        .auth-header .home-app-name span { color: var(--theme-green); }  
        .auth-header p { color: var(--theme-secondary-text); margin-bottom: 2rem; font-size: 1rem; }  
        .auth-page .form-group { text-align: left; margin-bottom: 1.5rem; }  
        .auth-page .form-group label { font-weight: 600; }  
        .auth-page .form-group input { border-radius: 8px; padding: 0.8rem; font-size: 1rem; }  
        .auth-page .btn-primary { width: 100%; padding: 0.8rem; font-size: 1rem; border-radius: 8px; margin-top: 1rem; font-weight: 600; }  
        .auth-toggle-link { margin-top: 1.5rem; color: var(--theme-secondary-text); }  
        .auth-toggle-link a { color: var(--theme-blue); font-weight: 600; text-decoration: none; }  
        .auth-toggle-link a:hover { text-decoration: underline; }  

        /* CURRENT LOCATION & NOTIFICATION STYLES */
        .current-location-section, .notification-section { margin: 1.5rem 0; padding: 1.5rem; border-radius: 8px; color: white; text-align: center; }
        .current-location-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
        .notification-section { background: linear-gradient(135deg, #FF9966 0%, #FF5E62 100%); box-shadow: 0 4px 15px rgba(255, 94, 98, 0.3); margin-top: 2rem; display: none; }
        .notification-section.visible { display: block; }
        
        .current-location-section h3, .notification-section h3 { font-size: 1.2rem; margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .current-location-btn { background: white; color: #667eea; border: none; padding: 0.8rem 1.5rem; border-radius: 50px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; transition: transform 0.2s; }
        .notification-btn { background: white; color: #FF5E62; border: none; padding: 0.8rem 1.5rem; border-radius: 50px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; transition: transform 0.2s; }
        .current-location-btn:hover, .notification-btn:hover { transform: translateY(-2px); }

        .location-capture-status { background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 1rem; margin-top: 1rem; text-align: left; border: 2px solid rgba(255, 255, 255, 0.3); }
        .location-capture-status.captured { border-color: #4ade80; background: rgba(74, 222, 128, 0.1); }
        .location-capture-badge { display: inline-flex; align-items: center; gap: 5px; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; margin-left: 10px; }
        .location-capture-badge.not-captured { background: #ff5757; color: white; }
        .location-capture-badge.captured { background: #4ade80; color: white; }
        
        /* WELCOME PAGE STYLES */
        .welcome-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2500; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; }
        .welcome-screen img { width: 120px; height: 120px; margin-bottom: 20px; }
        .welcome-title { font-size: 2rem; font-weight: 700; color: var(--theme-text); margin-bottom: 0.5rem; }
        .welcome-title span { color: var(--theme-green); }
        .welcome-text { color: var(--theme-secondary-text); margin-bottom: 3rem; text-align: center; }
        .welcome-btn { width: 100%; max-width: 300px; padding: 1rem; border-radius: 5px; font-weight: 600; text-align: center; margin-bottom: 1rem; cursor: pointer; transition: 0.3s; }
        .btn-login { background: var(--theme-blue); color: white; border: none; }
        .btn-explore { background: white; color: var(--theme-blue); border: 2px solid var(--theme-blue); }
        

        @media (max-width: 767px) {  
            .page-title { font-size: 1.3rem; }  
            .product-grid { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }  
            #related-products-grid { grid-template-columns: repeat(2, 1fr); }  
            .category-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }  
            .product-detail-layout { grid-template-columns: 1fr; }  
            .list-item { flex-direction: column; align-items: flex-start; text-align: center; }  
            .list-item img { margin: 0 auto 0.8rem; }  
            .list-item-actions { width: 100%; justify-content: center; }  
            .current-location-btn { width: 100%; justify-content: center; }
        }  
          
        @media (min-width: 768px) { #related-products-grid { grid-template-columns: repeat(4, 1fr); } }  

        .success-animation { margin: 20px auto; position: relative; }  
        .checkmark { width: 100px; height: 100px; border-radius: 50%; display: block; stroke-width: 2; stroke: #4bb71b; stroke-miterlimit: 10; box-shadow: inset 0px 0px 0px #4bb71b; animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both; position: relative; margin: 0 auto; }  
        .checkmark__circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 2; stroke-miterlimit: 10; stroke: #4bb71b; fill: #fff; animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }  
        .checkmark__check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards; }  
        @keyframes stroke { 100% { stroke-dashoffset: 0; } }  
        @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }  
        @keyframes fill { 100% { box-shadow: inset 0px 0px 0px 30px #4bb71b; } }

        /* =================================================================
           RESELLING (EARN MONEY) STYLES
           ================================================================= */
        .resell-card {
            background: #fff;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--theme-card-shadow);
            border: 1px solid var(--theme-border);
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .stat-card {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
            border: 1px solid var(--theme-border);
        }
        .stat-card.primary {
            background: linear-gradient(135deg, var(--theme-blue), #1c5bc9);
            color: white;
            grid-column: 1 / -1;
        }
        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 0.2rem;
        }
        .stat-label {
            font-size: 0.85rem;
            color: var(--theme-secondary-text);
        }
        .stat-card.primary .stat-label { color: rgba(255,255,255,0.8); }
        .profit-input-group {
            display: flex;
            gap: 0.8rem;
            align-items: center;
            justify-content: center;
            margin: 1.5rem 0;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--theme-border);
        }
        .profit-input-group label {
            font-weight: 600;
            color: var(--theme-text);
            margin: 0;
        }
        .profit-input-group input {
            border: 2px solid var(--theme-border);
            border-radius: 6px;
            padding: 0.6rem 1rem;
            width: 120px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--theme-blue);
            transition: border-color 0.3s;
        }
        .profit-input-group input:focus {
            border-color: var(--theme-blue);
            outline: none;
        }
        .share-card-preview {
            border: 1px dashed var(--theme-blue);
            background: #f0f7ff;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
        }
        .withdrawal-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--theme-border);
        }
        .withdrawal-badge {
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .withdrawal-badge.Pending { background: #fff3cd; color: #856404; }
        .withdrawal-badge.Completed { background: #d4edda; color: #155724; }
        .withdrawal-badge.Cancelled { background: #f8d7da; color: #721c24; }
        
        /* WALLET STYLES */
        .payment-method.wallet-method {
            background-color: var(--wallet-bg);
            border-color: var(--wallet-color);
        }
        .payment-method.wallet-method .payment-method-icon {
            color: var(--wallet-color);
        }
        .wallet-deduction-summary {
            background-color: #f3e5f5;
            padding: 0.8rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            border: 1px dashed var(--wallet-color);
        }
        .wallet-deduction-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }
        .wallet-deduction-row.final {
            border-top: 1px solid rgba(0,0,0,0.1);
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            font-weight: 700;
            font-size: 1rem;
        }

        /* RESELLING SEARCH PASTE LINK STYLE */
        .reselling-link-paste-section {
            background: #fff;
            padding: 1rem;
            border-bottom: 1px solid var(--theme-border);
            margin-bottom: 1rem;
        }
        .reselling-divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 1rem 0;
            color: var(--theme-secondary-text);
            font-size: 0.85rem;
        }
        .reselling-divider::before, .reselling-divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid var(--theme-border);
        }
        .reselling-divider::before { margin-right: .5em; }
        .reselling-divider::after { margin-left: .5em; }
        
        .paste-link-group {
            display: flex;
            gap: 8px;
        }
        .paste-link-group input {
            flex-grow: 1;
            padding: 0.6rem;
            border: 1px solid var(--theme-border);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        /* IMPROVED SEARCH HEADER FOR RESELLING */
        #reselling-create-page .search-header {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-bottom: 1px solid #f0f0f0;
            padding: 1rem;
        }
        #reselling-create-page input[type="search"] {
            font-size: 1.1rem;
            padding: 0.5rem;
        }
        
        /* PRODUCT ID BADGE STYLE */
        .product-id-badge {
            background-color: #f1f3f6;
            color: var(--theme-secondary-text);
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            border: 1px dashed var(--theme-border);
            transition: all 0.2s;
        }
        .product-id-badge:hover {
            background-color: #e3f2fd;
            color: var(--theme-blue);
            border-color: var(--theme-blue);
        }
        .product-id-badge i {
            font-size: 0.9rem;
        }
        
        /* MY LINKS HISTORY STYLE */
        .history-link-card {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--theme-border);
            gap: 1rem;
        }
        .history-link-card.clickable {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .history-link-card.clickable:hover {
            background-color: #f8f9fa;
        }
        .history-link-img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        .history-link-info {
            flex: 1;
        }
        .history-link-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* RESELLING LINK DETAILS PAGE */
        .link-detail-header {
            text-align: center;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: var(--theme-card-shadow);
        }
        .breakdown-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: var(--theme-card-shadow);
            margin-bottom: 1rem;
        }
        .breakdown-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        .breakdown-row.highlight {
            font-weight: 700;
            color: var(--theme-blue);
            border-top: 1px dashed var(--theme-border);
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }

        /* PREMIUM DUCK WALLET CARD (PROFILE PAGE) - IMPROVED DESIGN */
        .wallet-container {
            position: relative;
            margin-bottom: 1.5rem;
            margin-top: 1rem; /* Added gap */
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(91, 36, 122, 0.3);
        }

        .duck-wallet-profile-card {
            background: var(--card-gradient);
            color: white;
            padding: 1.5rem;
            border-radius: 16px;
            position: relative;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all 0.3s;
        }

        /* Glassmorphism Effect */
        .duck-wallet-profile-card.glass-effect::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
            z-index: 1;
        }

        .card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 2;
        }

        .card-chip {
            width: 40px;
            height: 30px;
            background: linear-gradient(135deg, #ffd700, #ffae00);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }
        .card-chip::after {
            content: '';
            position: absolute;
            top: 50%; left: 0; width: 100%; height: 1px; background: rgba(0,0,0,0.3);
        }
        .card-chip::before {
            content: '';
            position: absolute;
            left: 50%; top: 0; width: 1px; height: 100%; background: rgba(0,0,0,0.3);
        }

        .card-contactless {
            font-size: 1.5rem;
            opacity: 0.8;
            transform: rotate(90deg);
        }

        .card-balance-section {
            z-index: 2;
            margin-top: 10px;
        }

        .card-label {
            font-size: 0.8rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .card-balance-amount {
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-family: 'Share Tech Mono', monospace;
        }

        .card-bottom {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            z-index: 2;
        }

        /* GIF STYLE PREMIUM MEMBER TEXT ANIMATION */
        .card-holder {
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-family: 'Share Tech Mono', monospace;
            font-weight: 700;
            
            /* GIF-LIKE SHIMMER EFFECT */
            background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            background-size: 200% auto;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            animation: shine 3s linear infinite;
        }

        @keyframes shine {
            to {
                background-position: 200% center;
            }
        }

        .card-logo {
            font-weight: 800;
            font-style: italic;
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        /* BLURRED STATE & OVERLAY */
        .duck-wallet-profile-card.blurred {
            filter: blur(5px);
            pointer-events: none;
            opacity: 0.8;
        }

        .wallet-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            background: rgba(0,0,0,0.1);
            border-radius: 16px;
        }

        .btn-earn-overlay {
            background-color: var(--theme-green);
            color: white;
            font-weight: 700;
            padding: 0.8rem 1.5rem;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            text-transform: uppercase;
            font-size: 1rem;
            border: 2px solid white;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-earn-overlay:hover {
            transform: scale(1.05);
            background-color: #2e7d32;
        }

        /* ABOUT PAGE SPECIFIC STYLES */
        .about-wrapper {
            max-width: 480px;
            margin: auto;
            padding: 20px;
        }
        .about-header {
            text-align: center;
            margin-bottom: 24px;
        }
        .about-logo {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -0.5px;
            color: var(--theme-text);
        }
        .about-logo span {
            color: var(--about-brand);
        }
        .about-subtitle {
            font-size: 14px;
            color: var(--theme-secondary-text);
            margin-top: 6px;
        }
        .about-card {
            background: white;
            border-radius: 18px;
            padding: 22px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.06);
            animation: slideUp .6s ease;
        }
        .about-section {
            margin-bottom: 22px;
        }
        .about-section h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--theme-text);
        }
        .about-section p {
            font-size: 14px;
            line-height: 1.7;
            color: var(--theme-secondary-text);
        }
        .about-highlight {
            margin-top: 10px;
            padding: 12px;
            border-radius: 12px;
            background: rgba(22,163,74,.08);
            color: var(--about-brand-dark);
            font-size: 13px;
            font-weight: 600;
        }
        .about-list {
            margin-top: 8px;
        }
        .about-list li {
            list-style: none;
            padding: 7px 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            color: var(--theme-secondary-text);
        }
        .about-list li::before {
            content: "";
            color: var(--about-brand);
            font-weight: 700;
            margin-right: 10px;
        }
        .about-btn {
            width: 100%;
            margin-top: 14px;
            padding: 14px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 14px;
            background: transparent;
            border: 2px solid var(--about-brand);
            color: var(--about-brand);
            cursor: pointer;
            transition: .3s ease;
        }
        .about-btn:hover {
            background: var(--about-brand);
            color: #fff;
            transform: translateY(-1px);
        }
        .about-footer {
            text-align: center;
            margin-top: 18px;
            font-size: 12px;
            color: var(--theme-secondary-text);
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(18px); }
            to { opacity: 1; transform: translateY(0); }
        }

    </style>

</head>  
<body>  
    <!-- SLIDE-IN SIDE MENU -->  
    <div id="menu-overlay" class="menu-overlay"></div>  
    <nav id="side-menu" class="side-menu">  
        <ul>  
            <li><a href="#home" class="side-menu-link"><i class="fas fa-home"></i> Home</a></li>
            <!-- ADDED RESELLING LINK -->
            <li><a href="#reselling-dashboard" class="side-menu-link"><i class="fas fa-rupee-sign"></i> Earn Money</a></li>
            <li><a href="#favourites" class="side-menu-link"><i class="fas fa-heart"></i> Favourites</a></li>  
            <li><a href="#cart" class="side-menu-link"><i class="fas fa-shopping-cart"></i> Cart</a></li>  
            <li class="protected-route d-none"><a href="#orders" class="side-menu-link"><i class="fas fa-box"></i> Orders</a></li>  
            <li class="protected-route d-none"><a href="#profile" class="side-menu-link"><i class="fas fa-user"></i> Profile</a></li>  
            <!-- ADDRESS LINK REMOVED -->  
            <li><a href="#about" class="side-menu-link"><i class="fas fa-info-circle"></i> About</a></li>  
            <li><a href="#contact" class="side-menu-link"><i class="fas fa-phone"></i> Contact</a></li>  
        </ul>  
    </nav>  

    <header class="header">  
        <div class="container">  
            <a href="#home" class="logo">Duck<span>Shop</span></a>  
            <nav class="main-nav">  
                <ul>  
                    <li><a href="#home" class="nav-link">Home</a></li>  
                    <li><a href="#favourites" class="nav-link">Favourites</a></li>  
                    <li><a href="#cart" class="nav-link">Cart</a></li>  
                    <li class="protected-route d-none"><a href="#orders" class="nav-link">Orders</a></li>  
                    <li class="protected-route d-none"><a href="#profile" class="nav-link">Profile</a></li>  
                    <li><a href="#about" class="nav-link">About</a></li>  
                    <li><a href="#contact" class="nav-link">Contact</a></li>  
                </ul>  
            </nav>  
            <div class="header-icons">  
                <a href="#favourites" aria-label="Favourites"><i class="fas fa-heart"></i><span>Favourites</span><span id="wishlist-badge" class="badge">0</span></a>  
                <!-- CHANGED: Link points to #auth instead of #login -->
                <a href="#auth" id="auth-link" class="nav-link"><i class="fas fa-user"></i><span>Login</span></a>  
                <div class="hamburger" id="hamburger-menu"><i class="fas fa-bars"></i></div>  
            </div>  
        </div>  
    </header>  
      
    <main>  
        <!-- WELCOME PAGE (FLIPKART STYLE) -->
        <section id="welcome-page" class="page">
            <div class="welcome-screen">
                <div style="font-size: 4rem; color: var(--theme-blue); margin-bottom: 1rem;">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <div class="welcome-title">Duck<span>Shop</span></div>
                <p class="welcome-text">Best Products, Best Prices, Fast Delivery.</p>
                
                <button class="welcome-btn btn-login" onclick="window.location.hash='#auth'">Login / Register</button>
                <button class="welcome-btn btn-explore" onclick="window.location.hash='#home'">Explore</button>
            </div>
        </section>

        <!-- Home Page -->  
        <section id="home-page" class="page active">  
            <div class="home-specific-header">  
                <div class="home-top-bar">  
                    <div id="home-menu-icon" class="home-menu-icon">  
                        <i class="fas fa-bars"></i>  
                    </div>  
                    <div class="home-app-name">Duck<span>Shop</span></div>  
                    <div class="home-profile-icon">  
                         <a href="#profile" class="nav-link protected-route d-none"><i class="fas fa-user-circle"></i></a>  
                         <!-- CHANGED: Link points to #auth instead of #login -->
                         <a href="#auth" class="nav-link" id="home-auth-link"><i class="fas fa-user-circle"></i></a>  
                    </div>  
                </div>  
                <div id="home-search-trigger" class="home-search-trigger">  
                    <i class="fas fa-search"></i>  
                    <span>Search by Keyword or Product...</span>  
                </div>  
            </div>  

            <div id="home-category-scroller"></div>  
              
            <div class="page-content">  
                <div id="home-banner-container"></div>  
                <div class="products-for-you-header">  
                    <h2>Products For You</h2>  
                </div>  
                <div id="product-grid" class="product-grid"></div>  
            </div>  
        </section>  

        <!-- Search Page -->  
        <section id="search-page" class="page">  
            <div class="search-header">  
                <a href="#home" class="back-btn"><i class="fas fa-arrow-left"></i></a>  
                <input type="search" id="actual-search-input" placeholder="Search for products...">  
            </div>  
            <div id="search-results-grid" class="product-grid">  
                 <p class="empty-list-message" style="grid-column: 1 / -1;">Start typing to search for products.</p>  
            </div>  
        </section>  

        <!-- Category Products Page -->  
        <section id="category-products-page" class="page">  
            <h1 id="category-products-title" class="page-title"></h1>  
            <div id="category-product-grid" class="product-grid"></div>  
        </section>  
          
        <section id="product-detail-page" class="page"></section>  

        <!-- Favourites Page -->  
        <section id="favourites-page" class="page">  
            <h1 class="page-title">My Favourites</h1>  
            <div id="favourites-items" class="list-container"></div>  
        </section>  

        <!-- Cart Page - UPDATED TO FLIPKART STYLE -->  
        <section id="cart-page" class="page fk-cart-container">  
            <!-- Sticky Header inside main app header -->
            <div class="home-specific-header" style="position: sticky; top:0; z-index:99;">
                <h2 style="font-size: 1.1rem; font-weight: 500;">Shopping Cart</h2>
            </div>
            
            <div id="cart-items" style="padding: 10px 0;"></div>  
            <div id="cart-summary" class="d-none"></div>  
        </section>  

        <!-- Checkout Page: Step 1 Address (Modified: ONLY Current Location) -->  
        <section id="checkout-address-page" class="page protected-route d-none">  
            <div class="form-container">  
                <div class="checkout-stepper">
                    <div class="step-item active"><div class="step-circle"><i class="fas fa-check"></i></div> Location</div>
                    <div class="step-line"></div>
                    <div class="step-item"><div class="step-circle">2</div> Summary</div>
                    <div class="step-line"></div>
                    <div class="step-item"><div class="step-circle">3</div> Payment</div>
                </div>

                <div id="checkout-address-section">  
                    <h2 style="margin-bottom: 1rem;">Confirm Delivery Location</h2>  
                    
                    <div id="current-location-section" class="current-location-section">  
                        <h3><i class="fas fa-map-marker-alt"></i> Current Location Detection</h3>  
                        <p><strong>Mandatory:</strong> We need your location to calculate delivery charges.</p>  
                        
                        <div id="location-capture-status" class="location-capture-status">  
                            <h4>Location Status: <span class="location-capture-badge not-captured">Not Captured</span></h4>  
                            <p>Current location is required for order confirmation. Please click the button below to detect your location.</p>  
                        </div>  
                        
                        <button id="detect-location-btn" class="current-location-btn">  
                            <i class="fas fa-location-crosshairs"></i> Detect My Location  
                        </button>  
                        
                        <div id="location-message" class="d-none"></div>  
                        <div id="detected-address" class="detected-address d-none"></div>  
                    </div>  

                    <button id="address-step-continue-btn" class="btn btn-primary" style="width:100%; margin-top:1.5rem;" disabled>Deliver Here</button>
                </div>  
            </div>
        </section>

        <!-- Checkout Page: Step 2 Summary -->
        <section id="checkout-summary-page" class="page protected-route d-none">
            <!-- REMOVED ORDER SUMMARY TITLE AS REQUESTED -->
            <div class="form-container">
                <div class="checkout-stepper">
                    <div class="step-item active"><div class="step-circle"><i class="fas fa-check"></i></div> Location</div>
                    <div class="step-line" style="background:var(--theme-blue)"></div>
                    <div class="step-item active"><div class="step-circle"><i class="fas fa-check"></i></div> Summary</div>
                    <div class="step-line"></div>
                    <div class="step-item"><div class="step-circle">3</div> Payment</div>
                </div>

                <div id="checkout-summary-section">  
                     <div id="checkout-items-details"></div>  
                     <div id="checkout-charges-summary" style="margin-top: 1rem;"></div>  
                     <button id="summary-step-continue-btn" class="btn btn-primary" style="width:100%; margin-top:1.5rem;">Continue</button>
                </div> 
            </div>
        </section>

        <!-- Checkout Page: Step 3 Payment -->
        <section id="checkout-payment-page" class="page protected-route d-none">
            <!-- REMOVED PAYMENT TITLE AS REQUESTED -->
            <div class="form-container">
                <div class="checkout-stepper">
                    <div class="step-item active"><div class="step-circle"><i class="fas fa-check"></i></div> Location</div>
                    <div class="step-line" style="background:var(--theme-blue)"></div>
                    <div class="step-item active"><div class="step-circle"><i class="fas fa-check"></i></div> Summary</div>
                    <div class="step-line" style="background:var(--theme-blue)"></div>
                    <div class="step-item active"><div class="step-circle"><i class="fas fa-check"></i></div> Payment</div>
                </div>

                <div>  
                    <h2 style="margin-bottom: 1rem;">Payment Method</h2>  
                    
                    <!-- CASH ON DELIVERY OPTION -->
                    <div class="payment-method selected" data-method="cod" id="payment-cod">  
                        <div class="payment-method-header">  
                            <div class="payment-method-icon"><i class="fas fa-money-bill-wave"></i></div>  
                            <div class="payment-method-info">  
                                <div class="payment-method-name">Cash on Delivery</div>  
                                <div class="payment-method-desc">Pay with cash upon delivery.</div>  
                            </div>  
                            <div class="payment-method-check"><i class="fas fa-check-circle"></i></div>  
                        </div>  
                    </div> 

                    <!-- EARNING WALLET OPTION -->
                     <div class="payment-method wallet-method" data-method="wallet" id="payment-wallet">  
                        <div class="payment-method-header">  
                            <div class="payment-method-icon"><i class="fas fa-wallet"></i></div>  
                            <div class="payment-method-info">  
                                <div class="payment-method-name">Duck Wallet</div>  
                                <div class="payment-method-desc" id="wallet-balance-display">Loading balance...</div>  
                            </div>  
                            <div class="payment-method-check"><i class="fas fa-check-circle"></i></div>  
                        </div>  
                    </div> 
                </div>  
                
                <div id="order-confirmation-section" style="margin-top: 2rem;">  
                    <button id="final-confirm-order-btn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">  
                        Place Order  
                    </button>  
                </div>  
            </div>  
        </section>  

        <!-- Order Confirmation Page -->  
        <section id="order-confirmation-page" class="page protected-route d-none">  
            <div class="form-container text-center" style="padding-top: 3rem; padding-bottom: 3rem; border: none; box-shadow: none; background: transparent;">  
                <div class="success-animation">  
                    <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">  
                        <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" />  
                        <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" />  
                    </svg>  
                </div>  
                <h1 class="page-title" style="margin-bottom: 0.5rem; color: var(--theme-green); font-size: 1.8rem;">Order Placed!</h1>  
                <p style="color: var(--theme-secondary-text); margin-bottom: 2rem; font-size: 1.1rem;">Thank you for shopping with us. You can track your order status in the 'My Orders' section.</p>  
                <a href="#orders" class="btn btn-primary" style="width: 80%; max-width: 300px; border-radius: 50px;">Go to My Orders</a>  
            </div>  
        </section>  

        <!-- Orders Page - FLIPKART STYLE -->  
        <section id="orders-page" class="page protected-route d-none">  
            <div class="home-specific-header">
                <h2 style="font-size: 1.1rem; font-weight: 500;">My Orders</h2>
            </div>
            <!-- REMOVED FILTER BUTTON AND DELIVERY TEXT AS REQUESTED -->
            <div class="fk-order-search">
                <i class="fas fa-search" style="color:#878787;"></i>
                <input type="text" placeholder="Search your orders">
            </div>
            
            <div id="order-history" style="padding: 0 10px 10px 10px;"></div>  
        </section>  
          
        <!-- Order Detail Page (ORIGINAL PREMIUM DESIGN RESTORED) -->  
        <section id="order-detail-page" class="page protected-route d-none">  
            <!-- Content will be injected by JavaScript with ORIGINAL Layout -->  
        </section>  

        <!-- Profile Page (MODIFIED: REMOVED TITLE) -->  
        <section id="profile-page" class="page protected-route d-none">  
            <!-- Removed Title "My Profile" as requested -->
            <div class="form-container" style="margin-top: 1rem;">  
                
                <!-- DUCK WALLET PREMIUM CARD WRAPPER -->
                <div id="profile-wallet-container" class="wallet-container">
                    <!-- This content will be dynamically updated by JS -->
                    <div class="duck-wallet-profile-card blurred">
                        <div class="card-top">
                            <div class="card-chip"></div>
                            <div class="card-contactless"><i class="fas fa-wifi"></i></div>
                        </div>
                        <div class="card-balance-section">
                            <div class="card-label">Duck Wallet Balance</div>
                            <div class="card-balance-amount">0.00</div>
                        </div>
                        <div class="card-bottom">
                            <div class="card-holder">MEMBER</div>
                            <div class="card-logo">DuckShop</div>
                        </div>
                    </div>
                    <div class="wallet-overlay">
                        <button class="btn btn-earn-overlay" onclick="window.location.hash='#reselling-join'">
                            <i class="fas fa-coins"></i> Earn Money
                        </button>
                    </div>
                </div>

                <form id="profile-form" style="margin-top: 1rem;">  
                    <div class="form-group">  
                        <label for="profile-phone-display">Login ID (Phone Number)</label>  
                        <input type="tel" id="profile-phone-display" disabled>  
                    </div>  
                    <div class="form-group">  
                        <label for="profile-name">Full Name</label>  
                        <input type="text" id="profile-name" placeholder="Enter your full name" required>  
                    </div>  
                    <div class="form-group">  
                        <label for="profile-email">Email ID</label>  
                        <input type="email" id="profile-email" placeholder="Enter your email address">  
                    </div>  
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Update Changes</button>  
                </form>  
                <a href="#enter-old-password" class="btn btn-outline mt-1" style="width: 100%;">Change Password</a>  
                <button id="logout-link" class="btn btn-outline-danger mt-2" style="width: 100%;">Logout</button>  
            </div>  
        </section>  

        <!-- Enter Old Password Page -->  
        <section id="enter-old-password-page" class="page">  
            <h1 class="page-title">Change Password</h1>  
            <div class="form-container">  
                <form id="old-password-form">  
                    <div class="form-group">  
                        <label for="old-password">Enter Your Old Password</label>  
                        <input type="password" id="old-password" required>  
                    </div>  
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Continue</button>  
                </form>  
                <div class="text-center mt-2">  
                    <a href="#contact-for-old-password" class="nav-link">Contact to get old password</a>  
                </div>  
            </div>  
        </section>  

        <!-- New Password Page -->  
        <section id="new-password-page" class="page">  
            <h1 class="page-title">Set New Password</h1>  
            <div class="form-container">  
                <form id="new-password-form">  
                    <div class="form-group">  
                        <label for="new-password">New Password</label>  
                        <input type="password" id="new-password" required>  
                    </div>  
                    <div class="form-group">  
                        <label for="confirm-password">Confirm New Password</label>  
                        <input type="password" id="confirm-password" required>  
                    </div>  
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Save Password</button>  
                </form>  
            </div>  
        </section>  

        <!-- Contact for old password Page -->  
        <section id="contact-for-old-password-page" class="page">  
            <h1 class="page-title">Get Old Password</h1>  
            <div class="form-container text-center">  
                <p style="margin-bottom: 1.5rem; font-size: 1rem; color: var(--theme-secondary-text);">  
                    To get your old password, please click the WhatsApp button and talk to a Duck Shop team.  
                </p>  
                <a href="https://wa.me/919774966149?text=Hello%20Duck%20Shop%20team%20My%20Account%20Old%20Password%20Give%20me" class="btn btn-primary" style="background-color: #25D366; border-color: #25D366; font-size: 1.1rem; padding: 0.8rem 1.5rem;" target="_blank" rel="noopener noreferrer">  
                    <i class="fab fa-whatsapp"></i> Contact via WhatsApp  
                </a>  
            </div>  
        </section>  

        <!-- About Page (UPDATED WITH NEW CODE) -->  
        <section id="about-page" class="page">  
            <div class="about-wrapper">
                <div class="about-header">
                    <div class="about-logo">Duck<span>Shop</span></div>
                    <div class="about-subtitle">Order Today  Get It Today</div>
                </div>

                <div class="about-card">
                    <div class="about-section">
                        <h3>About DuckShop</h3>
                        <p>
                            Duck Shop is a modern and trusted shopping app built to deliver
                            quality products with speed and reliability.
                            We focus on providing a seamless, professional shopping experience
                            that saves time and ensures customer satisfaction.
                        </p>
                    </div>

                    <div class="about-section">
                        <h3>Fast & Same-Day Delivery</h3>
                        <p>
                            We offer <strong>home delivery with same-day and today fast service</strong>,
                            ensuring your orders reach you quickly and securely.
                        </p>
                        <div class="about-highlight">
                             Delivery available only in Khowai, Tripura
                        </div>
                    </div>

                    <div class="about-section">
                        <h3>Why Choose Duck Shop</h3>
                        <ul class="about-list">
                            <li>Verified and genuine products</li>
                            <li>Same-day / today delivery</li>
                            <li>Secure and careful packaging</li>
                            <li>Simple and fast ordering</li>
                            <li>Customer-focused support</li>
                        </ul>
                    </div>
                </div>

                <div class="about-footer">
                     2026 DuckShop  Fast & Secure Shopping Experience
                </div>
            </div>
        </section>  
          
        <!-- Contact Page -->  
        <section id="contact-page" class="page">  
            <h1 class="page-title">Contact Us</h1>  
            <div class="form-container text-center">  
                <p style="margin-bottom: 1.5rem; font-size: 1rem; color: var(--theme-secondary-text);">Have a question or need help with an order? Contact us directly on WhatsApp for a quick response.</p>  
                <a href="https://wa.me/919233550064?text=Reasons%3A-" class="btn btn-primary" style="background-color: #25D366; border-color: #25D366; font-size: 1.1rem; padding: 0.8rem 1.5rem;" target="_blank" rel="noopener noreferrer"><i class="fab fa-whatsapp"></i> Contact via WhatsApp</a>  
            </div>  
        </section>  
          
        <!-- ==============================================
             UNIFIED LOGIN/REGISTER FLOW START
             ============================================== -->

        <!-- Step 1: Check Phone Number Page -->
        <section id="auth-check-page" class="page auth-page">
            <div class="auth-container">
                <div class="auth-header">
                    <div class="home-app-name">Duck<span>Shop</span></div>
                    <p>Enter your phone number to continue.</p>
                </div>
                <form id="auth-check-form">
                    <div class="form-group">
                        <label for="auth-phone">10-Digit Phone Number</label>
                        <input type="tel" id="auth-phone" required maxlength="10" pattern="[0-9]{10}" placeholder="Enter number here">
                    </div>
                    <button type="submit" id="auth-check-btn" class="btn btn-primary">Continue</button>
                </form>
            </div>
        </section>

        <!-- Step 2: Login Page (For Existing Users) -->
        <section id="login-page" class="page auth-page">  
            <div class="auth-container">  
                <div class="auth-header">  
                    <div class="home-app-name">Duck<span>Shop</span></div>  
                    <p>Welcome back! Please login.</p>  
                </div>  
                <form id="login-form">  
                    <div class="form-group">  
                        <label for="login-phone">Phone Number (Verified)</label>  
                        <!-- READONLY: User cannot edit this -->
                        <input type="tel" id="login-phone" readonly style="background-color: #f1f3f6;">  
                    </div>  
                    <div class="form-group">  
                        <label for="login-password">Password</label>  
                        <input type="password" id="login-password" required>  
                    </div>  
                    <div class="form-group text-right" style="margin-bottom: 0;">  
                        <a href="#find-account">Forgot Password?</a>  
                    </div>  
                    <button type="submit" class="btn btn-primary">Login</button>  
                </form>  
                <p class="auth-toggle-link"><a href="#auth">Use a different number</a></p>  
            </div>  
        </section>  

        <!-- Step 3: Register Page (For New Users) -->
        <section id="register-page" class="page auth-page">  
            <div class="auth-container">  
                <div class="auth-header">  
                    <div class="home-app-name">Duck<span>Shop</span></div>  
                    <p>Create an account to start shopping.</p>  
                </div>  
                <form id="register-form">  
                    <div class="form-group">  
                        <label for="register-phone">Phone Number (Verified)</label>  
                        <!-- READONLY: User cannot edit this -->
                        <input type="tel" id="register-phone" readonly style="background-color: #f1f3f6;">  
                    </div>  
                     <div class="form-group">  
                        <label for="register-name">Full Name</label>  
                        <input type="text" id="register-name" required>  
                    </div>  
                    <div class="form-group">  
                        <label for="register-password">Password</label>  
                        <input type="password" id="register-password" required>  
                    </div>  
                    <div class="form-group">  
                        <label for="register-confirm-password">Confirm Password</label>  
                        <input type="password" id="register-confirm-password" required>  
                    </div>  
                    <button type="submit" class="btn btn-primary">Register</button>  
                </form>  
                <p class="auth-toggle-link"><a href="#auth">Use a different number</a></p>  
            </div>  
        </section>  
        
        <!-- ==============================================
             UNIFIED LOGIN/REGISTER FLOW END
             ============================================== -->

        <!-- Find Account Page -->  
        <section id="find-account-page" class="page auth-page">  
            <div class="auth-container">  
                <div class="auth-header">  
                    <div class="home-app-name">Duck<span>Shop</span></div>  
                    <p>Find your account</p>  
                </div>  
                <form id="find-account-form">  
                    <div class="form-group">  
                        <label for="find-account-phone">Enter your 10-Digit Phone Number</label>  
                        <input type="tel" id="find-account-phone" required maxlength="10" pattern="[0-9]{10}">  
                    </div>  
                    <button type="submit" class="btn btn-primary">Find Account</button>  
                </form>  
                <div id="found-account-details" class="d-none" style="margin-top: 1.5rem; border-top: 1px solid var(--theme-border); padding-top: 1.5rem; text-align: left;">  
                    <h4 style="text-align: center; margin-bottom: 0.5rem;">Account Found</h4>  
                    <p id="found-account-name" style="font-size: 1.1rem; font-weight: 600; text-align: center; margin-bottom: 1rem;"></p>  
                    <a href="#enter-old-password" class="btn btn-outline" style="width: 100%;">Change Password</a>  
                </div>  
                 <p class="auth-toggle-link">Remember your password? <a href="#auth">Login here</a></p>  
            </div>  
        </section> 

        <!-- =================================================================
             RESELLING SYSTEM PAGES START
             ================================================================= -->
        
        <!-- Reselling Join / Registration -->
        <section id="reselling-join-page" class="page protected-route d-none">
            <h1 class="page-title">Earn Money</h1>
            <div class="form-container text-center">
                <i class="fas fa-hand-holding-usd" style="font-size: 3rem; color: var(--theme-green); margin-bottom: 1rem;"></i>
                <h2>Become a Reseller</h2>
                <p style="color: var(--theme-secondary-text); margin-bottom: 2rem;">Start earning money by sharing products with your friends and family. Add your own profit margin!</p>
                <button id="create-reselling-account-btn" class="btn btn-primary" style="width: 100%;">Create Reselling Account</button>
            </div>
        </section>

        <!-- Reselling Dashboard -->
        <section id="reselling-dashboard-page" class="page protected-route d-none">
            <h1 class="page-title">Reselling Dashboard</h1>
            <div class="container">
                <div class="stat-grid">
                    <div class="stat-card primary">
                        <div class="stat-value" id="resell-total-earnings">0.00</div>
                        <div class="stat-label">Total Confirmed Profit</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="resell-pending-orders">0</div>
                        <div class="stat-label">Pending Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="resell-confirmed-orders">0</div>
                        <div class="stat-label">Confirmed Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="resell-pending-balance" style="color: #ff9800;">0.00</div>
                        <div class="stat-label">Pending Profit</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="resell-available-balance" style="color: var(--theme-green);">0.00</div>
                        <div class="stat-label">Duck Wallet</div>
                    </div>
                </div>
                
                <div class="text-center" style="margin-bottom: 2rem;">
                    <a href="#reselling-create" class="btn btn-success" style="width: 100%; margin-bottom: 0.5rem;"><i class="fas fa-plus"></i> Create Reselling Product</a>
                    <p style="font-size: 0.9rem; color: var(--theme-secondary-text); margin-top: 10px;">
                        <i class="fas fa-info-circle"></i> Duck Wallet balance only increases after order delivery.
                    </p>
                </div>

                <div class="resell-card">
                    <h3 style="margin-bottom: 1rem; font-size: 1.1rem;">My Reselling Links</h3>
                    <div id="reselling-history-list"></div>
                </div>
            </div>
        </section>

        <!-- Reselling Link Details Page (New) -->
        <section id="reselling-link-details-page" class="page protected-route d-none">
            <!-- Content Injected by JS -->
        </section>

        <!-- Create Reselling Product (Just Paste Link) -->
        <section id="reselling-create-page" class="page protected-route d-none">
            <!-- REPLACED CONTENT WITH PASTE LINK ONLY -->
            <h1 class="page-title">Create Reselling Link</h1>
            <div class="container" style="display: flex; flex-direction: column; justify-content: center; min-height: 50vh;">
                <div class="form-container text-center">
                    <i class="fas fa-barcode" style="font-size: 3rem; color: var(--theme-blue); margin-bottom: 1rem;"></i>
                    <h3 style="margin-bottom: 1.5rem;">Enter 5-Digit Product ID</h3>
                    
                    <div class="paste-link-group" style="margin-bottom: 1rem;">
                        <input type="number" id="reselling-paste-link-input" placeholder="Enter Product ID (e.g. 12345)" style="width: 100%; padding: 1rem; border: 2px solid var(--theme-border); border-radius: 8px; font-size: 1.2rem; text-align: center;">
                    </div>
                    
                    <button id="reselling-process-link-btn" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem;">Select Product</button>
                    
                    <div style="margin-top: 2rem; padding: 1rem; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 6px; color: #856404; font-size: 0.9rem; text-align: left;">
                        <i class="fas fa-exclamation-triangle"></i> <strong>Note:</strong> Only Duck Shop product IDs are supported. IDs from other companies (Amazon, Flipkart, etc.) will not work.
                    </div>
                    
                    <a href="#home" class="btn btn-outline mt-2" style="width: 100%;">Browse Products to Find ID</a>
                </div>
            </div>
        </section>

        <!-- Product Price Customization -->
        <section id="reselling-product-setup-page" class="page protected-route d-none">
            <h1 class="page-title">Set Profit</h1>
            <div class="form-container">
                <div id="resell-setup-product-preview"></div>
                
                <div class="profit-input-group">
                    <label>Your Profit ():</label>
                    <input type="number" id="resell-profit-input" min="1" max="100" value="10">
                </div>
                <p class="text-center" style="font-size: 0.8rem; color: var(--theme-secondary-text);">Min: 1 | Max: 100</p>
                <div class="text-center" style="margin: 1rem 0;">
                     <p>Final Price for Customer: <strong id="resell-final-price-display">0</strong></p>
                </div>
                
                <button id="generate-resell-link-btn" class="btn btn-primary" style="width: 100%;">Create Reselling Link</button>
            </div>
        </section>

        <!-- Share Link Page -->
        <section id="reselling-share-page" class="page protected-route d-none">
            <h1 class="page-title">Share Link</h1>
            <div class="form-container text-center">
                <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--theme-green); margin-bottom: 1rem;"></i>
                <h2>Link Generated!</h2>
                <div class="share-card-preview">
                    <p style="font-weight: 600; margin-bottom: 0.5rem;">Copy & Share:</p>
                    <input type="text" id="resell-generated-link" readonly style="width: 100%; padding: 0.5rem; border: 1px solid var(--theme-border); text-align: center; margin-bottom: 1rem; font-size: 0.85rem;">
                    <button id="copy-resell-link-btn" class="btn btn-sm btn-outline">Copy Link</button>
                </div>
                <a id="whatsapp-share-btn" href="#" target="_blank" class="btn btn-success" style="width: 100%; margin-top: 1rem;">
                    <i class="fab fa-whatsapp"></i> Share on WhatsApp
                </a>
                <a href="#reselling-dashboard" class="btn btn-outline" style="width: 100%; margin-top: 0.5rem;">Back to Dashboard</a>
            </div>
        </section>
        
        <!-- =================================================================
             RESELLING SYSTEM PAGES END
             ================================================================= -->

    </main>  
      
    <footer class="footer">  
        <div class="container">  
            <div class="social-links" id="social-links-container"></div>  
            <p>&copy; 2026 DuckShop. Fast & Secure Shopping Experience.</p>  
        </div>  
    </footer>  

    <nav class="bottom-nav">  
        <a href="#home" class="nav-link">  
            <i class="fas fa-home"></i>  
            <span>Home</span>  
        </a>  
        <a href="#cart" class="nav-link">  
            <i class="fas fa-shopping-cart"></i>  
            <span>Cart</span>  
            <span id="bottom-cart-badge" class="cart-badge">0</span>  
        </a>  
        <a href="#orders" class="nav-link protected-route d-none">  
            <i class="fas fa-box"></i>  
            <span>My Orders</span>  
        </a>  
        <a href="#profile" class="nav-link protected-route d-none">  
            <i class="fas fa-user"></i>  
            <span>Profile</span>  
        </a>  
    </nav>  
  
    <div id="toast-notification" class="toast"></div>  

    <!-- SWIPER JS -->  
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>  

    <script type="module">  
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";  
        import { getDatabase, ref, get, set, push, onValue, update, off, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";  
        // IMPORT FCM SDK
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-messaging.js";

        // ==========================================================
        // FIREBASE CONFIGURATION
        // ==========================================================
        const firebaseConfig = {
          apiKey: "AIzaSyB7P6KPjrJXI2GBHvgRIj7-djZEb2itImQ",
          authDomain: "duckshop-2026.firebaseapp.com",
          databaseURL: "https://duckshop-2026-default-rtdb.firebaseio.com",
          projectId: "duckshop-2026",
          storageBucket: "duckshop-2026.firebasestorage.app",
          messagingSenderId: "707987638458",
          appId: "1:707987638458:web:014ceda971a863fbab9a83"
        };  
        const app = initializeApp(firebaseConfig);  
        const db = getDatabase(app);  
        
        // Initialize FCM
        let messaging;
        try {
            messaging = getMessaging(app);
        } catch(e) {
            console.warn("FCM not supported in this environment");
        }

        const VAPID_KEY = "BAlXTx6vpB9zYTpD-5bxLGZYRpBn64E-jPrtJtR8vgeDfhZsg0FEfgBswtDyDNEizmqMKbZPEfjQfF-ZIx6Xkdg"; 
          
        const ADMIN_PHONE = "ADMIN_PHONE_HERE";  
          
        let allProducts = [];  
        let allCategories = [];  
        let allOrders = {};   
        let currentUser = null;   
        let userCart = {};  
        let userFavourites = [];  
        let appliedDiscount = null;  
        let validDiscounts = {};  
        let userUsedDiscounts = {};  
        let activeListeners = {};  
        
        // ==============================================================
        // DYNAMIC DELIVERY CHARGE VARIABLES (FETCHED FROM DB)
        // ==============================================================
        let calculatedDeliveryFee = 40; 
        let adminLocation = { latitude: 24.06, longitude: 91.60 }; // Default Khowai location fallback
        let distanceInKm = 0;
        let deliveryPerKm = 10; // Default Cost Per KM
        let minDeliveryCharge = 10; // Default Minimum Charge
          
        let bannerInstance = null;  
        let productSwiperInstance = null;  
            
        let selectedPaymentMethod = 'cod';   
        // UPDATED: shopStatus defaults with time logic support
        let shopStatus = { isOpen: true, closedMessage: "Shop is currently closed.", openHour: 10, closeHour: 21 };  
        let passwordRecoveryUserPhone = null;  
        
        let currentDetectedLocation = null;
        let currentDetectedAddress = null; // Store address for checkout here instead of DB 
        let isLocationCaptured = false;  
        
        // GLOBAL VARIABLE FOR AUTH FLOW
        let verifiedAuthPhone = null;

        // --- RESELLING SYSTEM VARIABLES ---
        let resellerData = null;
        let activeResellingSession = null; // Stores info if user came from a reselling link
        // ----------------------------------

        const pages = document.querySelectorAll('.page');  
        const productGrid = document.getElementById('product-grid');  
        const favouritesBadge = document.getElementById('wishlist-badge');  
        const bottomCartBadge = document.getElementById('bottom-cart-badge');  
        const hamburgerMenu = document.getElementById('hamburger-menu');  
        const homeSearchTrigger = document.getElementById('home-search-trigger');  
        const actualSearchInput = document.getElementById('actual-search-input');  
        const searchResultsGrid = document.getElementById('search-results-grid');  

        const showToast = (message, type = 'success') => {  
            const toast = document.getElementById('toast-notification');  
            toast.textContent = message;  
            toast.className = `toast show ${type}`;  
            setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);  
        };  

        // --- NEW FUNCTION: CHECK SHOP OPEN STATUS (TIME BASED) ---
        const getShopState = () => {
            // 1. Check Admin Manual Override
            if (shopStatus.isOpen === false) {
                return {
                    isOpen: false,
                    message: shopStatus.closedMessage || "Shop is currently closed manually."
                };
            }

            // 2. Check Time Schedule
            const now = new Date();
            const currentHour = now.getHours(); // 0-23
            // Defaults: 10 AM to 9 PM (21:00)
            const openHour = shopStatus.openHour || 10;
            const closeHour = shopStatus.closeHour || 21;

            if (currentHour >= openHour && currentHour < closeHour) {
                return { isOpen: true };
            } else {
                // Formatting time for message
                const ampm = openHour >= 12 ? 'PM' : 'AM';
                const displayHour = openHour % 12 || 12;
                const timeString = `${displayHour}:00 ${ampm}`;
                
                // Logic for "Today" vs "Tomorrow"
                let message = "";
                if(currentHour >= closeHour) {
                    message = `Shop is closed today. Will open tomorrow at ${timeString}`;
                } else {
                    // Early morning case
                    message = `Shop is closed. Will open today at ${timeString}`;
                }

                return {
                    isOpen: false,
                    message: message
                };
            }
        };

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./firebase-messaging-sw.js').catch(console.error);
        }
        const requestPermissionAndGetToken = async () => {
            if (!messaging) return;
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    const token = await getToken(messaging, { vapidKey: VAPID_KEY });
                    if (token && currentUser) {
                        await set(ref(db, `users/${currentUser.phone}/fcmToken`), token);
                    }
                }
            } catch (error) { console.error('Token error', error); }
        };
        if(messaging) {
            onMessage(messaging, (payload) => {
                const { title, body } = payload.notification;
                const toast = document.getElementById('toast-notification');  
                toast.innerHTML = `<i class="fas fa-bell"></i> <strong>${title}</strong><br>${body}`;  
                toast.className = `toast show notification`;
                new Audio('https://notificationsounds.com/storage/sounds/file-sounds-1150-pristine.mp3').play().catch(e=>console.log(e));
                setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 5000); 
            });
        }
        const checkNotificationStatus = async () => {
            if(currentUser) requestPermissionAndGetToken();
        }

        // ==========================================================
        // APP LOGIC
        // ==========================================================

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; 
            var dLat = deg2rad(lat2-lat1);  
            var dLon = deg2rad(lon2-lon1); 
            var a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            var d = R * c; 
            return d;
        }
        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }

        const formatCurrency = (amount) => {
            if (amount === undefined || amount === null || isNaN(amount)) {
                return '0.00';
            }
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount);  
        };

        const getShortProductId = (id) => {
            let hash = 0;
            for (let i = 0; i < id.length; i++) {
                hash = id.charCodeAt(i) + ((hash << 5) - hash);
            }
            return (Math.abs(hash) % 90000) + 10000;
        };

        const generateNumericOrderId = (firebaseKey) => {  
            let hash = 0; if (!firebaseKey || firebaseKey.length === 0) return '000000000000';  
            for (let i = 0; i < firebaseKey.length; i++) { hash = ((hash << 5) - hash) + firebaseKey.charCodeAt(i); hash |= 0; }  
            return ('90' + Math.abs(hash).toString()).padEnd(12, '0').substring(0, 12);  
        };  
        const generateStockDisplayHtml = (stock) => {  
            const stockNum = parseInt(stock) || 0;  
            if (stockNum > 5) return `<p id="stock-display" class="product-stock-status stock-high">In Stock</p>`;  
            if (stockNum > 0) return `<p id="stock-display" class="product-stock-status stock-low">Hurry! Only ${stockNum} left in stock!</p>`;  
            return `<p id="stock-display" class="product-stock-status stock-out">Out of Stock</p>`;  
        };  
          
        /* 
           =========================================================
           UPGRADED PREMIUM SKELETON RENDER FUNCTION
           =========================================================
        */
        const renderSkeletons = () => {  
            const container = document.getElementById('product-grid');  
            if(container) {  
                const skeletonHTML = `
                    <div class="premium-skeleton-card">
                        <div class="sk-animate sk-image-box"></div>
                        <div class="sk-animate sk-line-title"></div>
                        <div class="sk-animate sk-line-subtitle"></div>
                        <div class="sk-price-wrapper">
                            <div class="sk-animate sk-line-price"></div>
                            <div class="sk-animate sk-line-cut"></div>
                        </div>
                        <div class="sk-animate sk-circle-btn"></div>
                    </div>
                `;
                container.innerHTML = Array(8).fill(skeletonHTML).join('');  
            }  
        };  

        const renderHomeCategoryScroller = () => {  
            const container = document.getElementById('home-category-scroller');  
            if (!container) return;  
            const fastFoodCat = allCategories.find(c => c.name.toLowerCase().includes('fast') && c.name.toLowerCase().includes('food'));  
            const groceryCat = allCategories.find(c => c.name.toLowerCase().includes('grocery'));  
            let html = '';  
            if (fastFoodCat) html += `<div class="home-category-item cat-fast-food" data-category-id="${fastFoodCat.id}" data-category-name="${fastFoodCat.name}"><img src="${fastFoodCat.imageUrl}" alt="${fastFoodCat.name}" loading="lazy" onload="this.classList.add('loaded')"><span>Fast Food</span></div>`;  
            if (groceryCat) html += `<div class="home-category-item cat-grocery" data-category-id="${groceryCat.id}" data-category-name="${groceryCat.name}"><img src="${groceryCat.imageUrl}" alt="${groceryCat.name}" loading="lazy" onload="this.classList.add('loaded')"><span>Grocery</span></div>`;  
            container.innerHTML = html || `<p style="grid-column: 1 / -1; text-align: center;">Categories unavailable</p>`;  
        };  

        const startAppListeners = () => {  
            renderSkeletons();  
            onValue(ref(db, 'products'), (snapshot) => {  
                const productsFromDB = snapshot.val() || {};  
                allProducts = Object.keys(productsFromDB).map(key => ({ id: key, ...productsFromDB[key] })).filter(p => p.status === 'approved' || typeof p.status === 'undefined');  
                updateCurrentView();  
            });  
            onValue(ref(db, 'categories'), (snapshot) => {  
                allCategories = snapshot.exists() ? Object.keys(snapshot.val()).map(key => ({ id: key, ...snapshot.val()[key] })) : [];  
                renderHomeCategoryScroller(); updateCurrentView();  
            });  
            onValue(ref(db, 'app_config/shop_status'), (snapshot) => { 
                // Default fallback if DB is empty
                shopStatus = snapshot.val() || { isOpen: true, closedMessage: "Shop is currently closed.", openHour: 10, closeHour: 21 }; 
                if (window.location.hash.startsWith('#product')) updateCurrentView(); 
            });  
            onValue(ref(db, 'app_config/social_links'), (snapshot) => { const c = document.getElementById('social-links-container'); c.innerHTML = ''; if (snapshot.exists()) { const l = snapshot.val(); let h = ''; if(l.telegram)h+=`<a href="${l.telegram}" target="_blank"><i class="fab fa-telegram-plane"></i></a>`; if(l.facebook)h+=`<a href="${l.facebook}" target="_blank"><i class="fab fa-facebook-f"></i></a>`; if(l.instagram)h+=`<a href="${l.instagram}" target="_blank"><i class="fab fa-instagram"></i></a>`; if(l.whatsapp)h+=`<a href="${l.whatsapp}" target="_blank"><i class="fab fa-whatsapp"></i></a>`; c.innerHTML = h; } });  
            
            // Get Admin Location for distance calculation
            onValue(ref(db, 'app_config/shop_location'), (snapshot) => { 
                if (snapshot.exists()) {
                    adminLocation = snapshot.val();
                }
            });

            // ==============================================================
            // LISTEN FOR DYNAMIC DELIVERY SETTINGS
            // ==============================================================
            onValue(ref(db, 'app_config/delivery_settings'), (snapshot) => {
                if(snapshot.exists()) {
                    const settings = snapshot.val();
                    deliveryPerKm = settings.costPerKm || 10;
                    minDeliveryCharge = settings.minCharge || 10;
                    // If location is already captured, update the cost immediately
                    if(isLocationCaptured) {
                         // Recalculate based on new admin settings
                         let cost = distanceInKm * deliveryPerKm;
                         if (cost < minDeliveryCharge) cost = minDeliveryCharge;
                         calculatedDeliveryFee = Math.ceil(cost);
                         updateCartSummary(); // Refresh UI if cart is open
                    }
                }
            });
            
            onValue(ref(db, 'app_config/home_banners'), (snapshot) => {  
                const bannerContainer = document.getElementById('home-banner-container');  
                if (bannerInstance !== null) { bannerInstance.destroy(true, true); bannerInstance = null; }  
                if (snapshot.exists() && bannerContainer) {  
                    const banners = Object.values(snapshot.val()).filter(b => b && b.imageUrl);  
                    if (banners.length > 0) {  
                        bannerContainer.innerHTML = `<div class="swiper home-banner-swiper"><div class="swiper-wrapper">${banners.map(b => `<div class="swiper-slide"><a href="${b.linkUrl||'#'}" style="display:block; width:100%; height:100%;"><img src="${b.imageUrl}" alt="Banner" loading="lazy"></a></div>`).join('')}</div><div class="swiper-pagination"></div></div>`;  
                        bannerInstance = new Swiper(".home-banner-swiper", { slidesPerView: 1, spaceBetween: 0, loop: banners.length > 1, autoplay: { delay: 3500, disableOnInteraction: false }, pagination: { el: ".swiper-pagination", clickable: true }, });  
                        bannerContainer.style.display = 'block';  
                    } else { bannerContainer.style.display = 'none'; }  
                } else if (bannerContainer) { bannerContainer.style.display = 'none'; }  
            });  
            listenForDiscounts();  
        };  

        const updateCurrentView = () => {   
            const h=window.location.hash||'#home'; const [b,q]=h.split('?'); const p=new URLSearchParams(q);   
            if(b==='#home')renderHomePage();   
            else if(b==='#search')renderSearchPage();   
            else if(b==='#favourites')renderFavourites();   
            else if(b==='#product'&&p.has('id'))renderProductDetailPage(p.get('id'), p.get('r_link')); // Pass r_link if present  
            else if(b==='#category'&&p.has('id'))renderCategoryProductsPage(p.get('id'), p.get('name'));   
            else if(b==='#checkout')renderCheckoutPage();   
            else if(b==='#checkout-address')renderCheckoutAddressPage();
            else if(b==='#checkout-summary')renderCheckoutSummaryPage();
            else if(b==='#checkout-payment')renderCheckoutPaymentPage(); 
            else if(b==='#orders')renderOrders();  
            else if(b==='#order'&&p.has('id'))renderOrderDetailPage(p.get('id'));   
            
            // RESELLING ROUTES
            else if(b==='#reselling-join') renderResellingJoinPage();
            else if(b==='#reselling-dashboard') renderResellingDashboard();
            else if(b==='#reselling-create') renderResellingCreatePage();
            else if(b==='#reselling-product-setup'&&p.has('id')) renderResellingProductSetup(p.get('id'));
            else if(b==='#reselling-share'&&p.has('link')) renderResellingSharePage(p.get('link'));
            else if(b==='#reselling-link-details'&&p.has('id')) renderResellingLinkDetailsPage(p.get('id'));

            if(b==='#login' || b==='#register'){
                if(!verifiedAuthPhone){
                    window.location.hash = '#auth';
                    return;
                }
                if(b==='#login'){
                     document.getElementById('login-phone').value = verifiedAuthPhone;
                } else if(b==='#register'){
                     document.getElementById('register-phone').value = verifiedAuthPhone;
                }
            }
        };  
        const listenForDiscounts = () => { onValue(ref(db,'discounts'),(s)=>{ validDiscounts={}; if(s.exists()){ Object.values(s.val()).forEach(d=>{ const c=d.code.toUpperCase(); validDiscounts[c]={...d,code:c}; }); } if(appliedDiscount)updateCartSummary(); }); };  
          
        const handleRouting = async () => {   
            const h=window.location.hash||'#home'; const [b,q]=h.split('?'); const p=new URLSearchParams(q);  
            
            // Welcome Page Logic
            if(b === '#welcome') {
                document.getElementById('welcome-page').classList.add('active');
                document.querySelector('.header').style.display = 'none';
                document.querySelector('.bottom-nav').style.display = 'none';
                pages.forEach(pg => { if(pg.id !== 'welcome-page') pg.classList.remove('active'); });
                return;
            } else {
                 document.querySelector('.header').style.display = ''; // Reset
                 document.querySelector('.bottom-nav').style.display = 'flex'; // Reset
            }

            if (b === '#order-confirmation') { const audio = document.getElementById('success-sound'); if(audio) { audio.currentTime = 0; audio.play().catch(e => console.log(e)); } const animContainer = document.querySelector('.success-animation'); if(animContainer) { const html = animContainer.innerHTML; animContainer.innerHTML = ''; void animContainer.offsetWidth; animContainer.innerHTML = html; } }  
            if (!['#find-account', '#enter-old-password', '#new-password', '#contact-for-old-password'].includes(b)) { passwordRecoveryUserPhone = null; }  
            pages.forEach(pg=>pg.classList.remove('active'));   
            let t;   
            
            // CHECK FOR RESELLING LINK (ASYNC LOAD)
            // If viewing a product with r_link, show loading skeleton instantly to prevent price glitch
            if(b==='#product' && p.has('r_link')) {
                 t=document.getElementById('product-detail-page');
                 t.classList.add('active');
                 // Show Skeleton inside t
                 t.innerHTML = `<div class="container" style="padding-top:2rem; max-width:900px; margin:0 auto;">
                    <div class="skeleton" style="height:350px; margin-bottom:1rem;"></div>
                    <div class="skeleton skeleton-text" style="width:70%; height:25px; margin-bottom:1rem;"></div>
                    <div class="skeleton skeleton-text" style="width:40%; height:20px;"></div>
                    <div class="skeleton" style="height:50px; margin-top:1rem;"></div>
                 </div>`;
                 // Now fetch data
                 await handleIncomingResellingLink(p.get('r_link'));
            } else if (!b.startsWith('#checkout') && !b.startsWith('#product')) {
                if(b==='#product' && !p.has('r_link')) {
                    activeResellingSession = null;
                }
            }

            if(b==='#product'&&p.has('id')){t=document.getElementById('product-detail-page');}   
            else if(b==='#category'&&p.has('id')){t=document.getElementById('category-products-page');}    
            else if(b==='#order'&&p.has('id')){t=document.getElementById('order-detail-page');}  
            else if(b==='#order-confirmation'){t=document.getElementById('order-confirmation-page');}  
            else if(b==='#auth'){t=document.getElementById('auth-check-page');} 
            else if(b==='#login'){t=document.getElementById('login-page');}  
            else if(b==='#register'){t=document.getElementById('register-page');}  
            else if(b==='#find-account'){t=document.getElementById('find-account-page');}  
            else if(b==='#enter-old-password'){t=document.getElementById('enter-old-password-page');}  
            else if(b==='#new-password'){t=document.getElementById('new-password-page');}  
            else if(b==='#contact-for-old-password'){t=document.getElementById('contact-for-old-password-page');}  
            
            // CHECKOUT STEPS
            else if(b==='#checkout'){t=document.getElementById('checkout-address-page'); window.location.hash='#checkout-address';} 
            else if(b==='#checkout-address'){t=document.getElementById('checkout-address-page');} 
            else if(b==='#checkout-summary'){t=document.getElementById('checkout-summary-page');} 
            else if(b==='#checkout-payment'){t=document.getElementById('checkout-payment-page');} 

            // RESELLING IDS
            else if(b==='#reselling-join'){t=document.getElementById('reselling-join-page');}
            else if(b==='#reselling-dashboard'){t=document.getElementById('reselling-dashboard-page');}
            else if(b==='#reselling-create'){t=document.getElementById('reselling-create-page');}
            else if(b==='#reselling-product-setup'){t=document.getElementById('reselling-product-setup-page');}
            else if(b==='#reselling-share'){t=document.getElementById('reselling-share-page');}
            else if(b==='#reselling-link-details'){t=document.getElementById('reselling-link-details-page');}
            else {t=document.getElementById(`${b.substring(1)}-page`);}   
            
            if(t)t.classList.add('active');   
            else document.getElementById('home-page').classList.add('active');   
            

            updateCurrentView();   
            document.querySelectorAll('.nav-link, .side-menu-link').forEach(l=>{ const lh=l.getAttribute('href'); l.classList.toggle('active',(lh===b)||(b==='#category'&&lh==='#categories')||(b==='#order'&&lh==='#orders')||(b==='#reselling-dashboard'&&lh.startsWith('#resell'))); });   
            const protectedRoutes = ['#orders', '#profile', '#checkout', '#payment', '#order', '#order-confirmation', '#reselling-dashboard', '#reselling-create', '#reselling-link-details'];  
            if(protectedRoutes.some(route => b.startsWith(route)) && !currentUser){ window.location.hash='#auth'; showToast('Please log in.','error'); }   
            document.querySelector('.main-nav.active')?.classList.remove('active');   
            window.scrollTo(0,0);   
        };  
          
        const createProductCardHtml = (product, extraClass = '') => {   
            const isFavourited=userFavourites.includes(product.id);   
            let priceHtml,displayPrice,displayOriginalPrice,displayDiscountPercent,isOutOfStock;   
            const hasValidVariants=product.hasVariants&&Array.isArray(product.variants)&&product.variants.length>0;   
            if(hasValidVariants){const fv=product.variants[0]; displayPrice=fv.price; displayOriginalPrice=fv.originalPrice; if(displayOriginalPrice&&displayOriginalPrice>displayPrice){displayDiscountPercent=Math.round(((displayOriginalPrice-displayPrice)/displayOriginalPrice)*100);} isOutOfStock=product.variants.every(v=>v.stock<=0); }else{displayPrice=product.price; displayOriginalPrice=product.originalPrice; displayDiscountPercent=product.discountPercent; isOutOfStock=product.stock<=0;}   
            if(displayOriginalPrice&&displayOriginalPrice>displayPrice){priceHtml=`<div class="product-price-container"><span class="product-price">${formatCurrency(displayPrice)}</span><span class="product-price-original">${formatCurrency(displayOriginalPrice)}</span>${displayDiscountPercent?`<span class="product-discount-badge">${displayDiscountPercent}% OFF</span>`:''}</div>`;}else{priceHtml=`<div class="product-price-container"><span class="product-price">${formatCurrency(displayPrice)}</span></div>`;}   
            const cardImageUrl=(Array.isArray(product.imageUrls)&&product.imageUrls.length>0)?product.imageUrls[0]:product.imageUrl;   
            
            return `<div class="product-card ${extraClass} ${isOutOfStock?'out-of-stock':''}" data-id="${product.id}">${isOutOfStock?'<div class="product-stock-overlay">Out of Stock</div>':''}<img src="${cardImageUrl}" alt="${product.name}" class="product-image" loading="lazy" onload="this.classList.add('loaded')"><div class="product-info"><h3 class="product-name">${product.name}</h3><p class="product-category">${product.categoryName||'Uncategorized'}</p>${priceHtml}<div class="product-actions"><button class="icon-btn share-btn" data-action="share-product" data-id="${product.id}" aria-label="Share"><i class="fas fa-share-alt"></i></button><button class="icon-btn ${isFavourited?'active':''}" data-action="toggle-favourite" data-id="${product.id}" aria-label="Add to favourites"><i class="fas fa-heart"></i></button></div></div></div>`;   
        };  
          
        const renderProductDetailPage = (productId, r_link = null) => {  
            const container = document.getElementById('product-detail-page');  
            const product = allProducts.find(p => p.id === productId);  
            if (!product) { container.innerHTML = '<p class="empty-list-message">Product not found.</p>'; return; }  
            const isFavourited = userFavourites.includes(product.id);  
            const imageUrls = product.imageUrls && product.imageUrls.length > 0 ? product.imageUrls : [product.imageUrl];  
            if (productSwiperInstance !== null) { productSwiperInstance.destroy(true, true); productSwiperInstance = null; }  
            const variants = product.variants || []; const hasVariants = product.hasVariants && variants.length > 0;  
            
            // GENERATE 5 DIGIT ID
            const shortId = getShortProductId(product.id);

            // ADDED SHARE BUTTON TO DETAIL PAGE
            container.innerHTML = `<div class="product-detail-layout"><div class="product-detail-image-container"><div class="product-detail-secondary-actions"><div class="fav-btn-floating share-btn-floating" data-action="share-product-detail" data-id="${product.id}"><i class="fas fa-share-alt"></i></div><div class="fav-btn-floating ${isFavourited ? 'active' : ''}" data-action="toggle-favourite" data-id="${product.id}"><i class="fas fa-heart"></i></div></div><div class="swiper product-swiper"><div class="swiper-wrapper">${imageUrls.map(url => `<div class="swiper-slide"><img src="${url}" alt="${product.name}" loading="lazy" onload="this.classList.add('loaded')"></div>`).join('')}</div><div class="swiper-pagination"></div></div></div><div class="product-detail-info"><h1>${product.name}</h1>
            
            <!-- PRODUCT ID DISPLAY -->
            <div class="product-id-badge" onclick="navigator.clipboard.writeText('${shortId}').then(() => showToast('ID Copied!'))">
                ID: <strong>${shortId}</strong> <i class="far fa-copy"></i>
            </div>

            <div id="price-container"></div>${hasVariants ? `<div class="form-group"><label for="product-variant-select">Select Option:</label><select id="product-variant-select" class="form-control" style="width: 100%; padding: 0.6rem; border: 1px solid var(--theme-border); border-radius: 4px;">${variants.map((v, index) => `<option value="${index}">${v.name}</option>`).join('')}</select></div>` : ''}<div id="stock-container"></div><div id="product-detail-actions"></div><div class="product-detail-desc">${product.description || ''}</div></div></div><div id="related-products-container"></div>`;  
            productSwiperInstance = new Swiper(".product-swiper", { slidesPerView: 1, spaceBetween: 0, pagination: { el: ".swiper-pagination", clickable: true }, });  
            const relatedProductsContainer = document.getElementById('related-products-container'); const relatedProducts = allProducts.filter(p => p.categoryId === product.categoryId && p.id !== productId).sort(() => 0.5 - Math.random()).slice(0, 4);   
            if (relatedProducts.length > 0) { relatedProductsContainer.innerHTML = `<div class="related-products-section"><h2>Related Products</h2><div id="related-products-grid" class="product-grid">${relatedProducts.map(p => createProductCardHtml(p)).join('')}</div></div>`; }  
            
            const updateVariantDetails = (variantIndex = 0) => {  
                const priceContainer = document.getElementById('price-container'), stockContainer = document.getElementById('stock-container'), actionsContainer = document.getElementById('product-detail-actions');  
                let currentPrice, currentOriginalPrice, currentStock, currentVariantName = null, itemIdentifier;  
                if (hasVariants) { const selectedVariant = variants[variantIndex]; currentPrice = selectedVariant.price; currentOriginalPrice = selectedVariant.originalPrice; currentStock = selectedVariant.stock; currentVariantName = selectedVariant.name; itemIdentifier = `${product.id}_${currentVariantName}`; }   
                else { currentPrice = product.price; currentOriginalPrice = product.originalPrice; currentStock = product.stock; itemIdentifier = product.id; }  
                
                // CHECK RESELLING SESSION OVERRIDE
                if (activeResellingSession && activeResellingSession.productId === productId) {
                    currentPrice = parseInt(currentPrice) + parseInt(activeResellingSession.profit);
                    if(currentOriginalPrice && currentOriginalPrice > 0) {
                        let shopBasePrice = 0;
                         if (hasVariants) { shopBasePrice = variants[variantIndex].price; } 
                         else { shopBasePrice = product.price; }
                         if(currentOriginalPrice > 0) {
                            let originalDiscountFactor = (currentOriginalPrice - shopBasePrice) / currentOriginalPrice; 
                            if (originalDiscountFactor > 0 && originalDiscountFactor < 1) {
                                currentOriginalPrice = currentPrice / (1 - originalDiscountFactor);
                            }
                         }
                    }
                }

                let priceHtml = `<span class="product-detail-price">${formatCurrency(currentPrice)}</span>`;  
                if (currentOriginalPrice && currentOriginalPrice > currentPrice) { 
                    const discount = Math.round(((currentOriginalPrice - currentPrice) / currentOriginalPrice) * 100); 
                    priceHtml += `<span class="product-detail-price-original">${formatCurrency(currentOriginalPrice)}</span><span class="product-detail-discount-badge">${discount}% OFF</span>`; 
                }  
                
                priceContainer.innerHTML = `<div class="product-detail-price-container">${priceHtml}</div>`;  
                stockContainer.innerHTML = generateStockDisplayHtml(currentStock);  

                // CHECK SHOP OPEN STATUS
                const shopState = getShopState();

                if (userCart[itemIdentifier]) { 
                    actionsContainer.innerHTML = `<a href="#cart" class="btn btn-success">Go to Cart</a>`; 
                } else if (currentStock > 0 && shopState.isOpen) { 
                    actionsContainer.innerHTML = `<button class="btn btn-primary" data-action="add-to-cart-detail" data-id="${product.id}">Add to Cart</button>`; 
                } else { 
                    // Show specific closed message above disabled button if closed
                    let buttonText = 'Out of Stock';
                    let messageHtml = '';

                    if (!shopState.isOpen) {
                        buttonText = 'Shop Closed';
                        messageHtml = `<div class="shop-closed-message"><i class="fas fa-clock"></i> ${shopState.message}</div>`;
                    }

                    actionsContainer.innerHTML = `${messageHtml}<button class="btn btn-primary" disabled>${buttonText}</button>`; 
                }  
            };  
            updateVariantDetails();  
            if (hasVariants) { document.getElementById('product-variant-select').addEventListener('change', (e) => updateVariantDetails(e.target.value)); }  
        };  

        const renderHomePage = () => {   
            const allowed = ["Fast Food", "Grocery"]; const filtered = allProducts.filter(p => allowed.some(a => (p.categoryName && p.categoryName.toLowerCase().includes(a.toLowerCase()))));  
            const shuffled = [...filtered].sort(()=>0.5-Math.random());   
            productGrid.innerHTML = shuffled.length > 0 ? shuffled.map(p=>createProductCardHtml(p)).join('') : '<p class="empty-list-message" style="grid-column: 1 / -1;">loading products...</p>';  
        };  
        const renderSearchPage = () => { actualSearchInput.value=''; actualSearchInput.focus(); searchResultsGrid.innerHTML='<p class="empty-list-message" style="grid-column: 1 / -1;">Start typing to search.</p>'; };  
        const handleSearchInput = () => {   
            const s=actualSearchInput.value.toLowerCase().trim(); if(s.length<1){ searchResultsGrid.innerHTML='<p class="empty-list-message" style="grid-column: 1 / -1;">Start typing to search.</p>'; return; }   
            const f = allProducts.filter(p => p.name.toLowerCase().includes(s) && ["Fast Food", "Grocery"].some(a => (p.categoryName || '').toLowerCase().includes(a.toLowerCase())));  
            searchResultsGrid.innerHTML = f.length === 0 ? `<p class="empty-list-message" style="grid-column: 1 / -1;">No products found for "${s}".</p>` : f.map(p => createProductCardHtml(p)).join('');   
        };  
        const renderCategoryProductsPage = (id, name) => { document.getElementById('category-products-title').textContent=decodeURIComponent(name||'Category'); const p=allProducts.filter(pr=>pr.categoryId===id); document.getElementById('category-product-grid').innerHTML=p.length===0?'<p class="empty-list-message">No products in this category.</p>':p.map(pr=>createProductCardHtml(pr)).join(''); };  
          
        const addToCart = async (id,q=1,v=null)=>{   
            // Security check for shop status
            const shopState = getShopState();
            if(!shopState.isOpen) {
                showToast(shopState.message, 'error');
                return;
            }

            const p=allProducts.find(pr=>pr.id===id); if(!p)return; let cid,cdata;   
            
            // --- RESELLING PRICE LOGIC FOR CART ---
            let resellerInfo = null;
            let finalPriceToUse = p.price; // Default base price

            // Handle Variants first to get correct base price
            let availableStock = p.stock;

            if(p.hasVariants && Array.isArray(p.variants) && p.variants.length > 0 && v){ 
                const sv = p.variants.find(vr => vr.name === v); 
                if(!sv || sv.stock < q){ showToast('Out of stock','error'); return; } 
                finalPriceToUse = sv.price;
                availableStock = sv.stock;
            } 

            // --- QUANTITY CAP LOGIC ---
            // Max allowed is 5, but if stock is less than 5, max allowed is availableStock
            const maxAllowed = Math.min(availableStock, 5);

            if (q > maxAllowed) {
                q = maxAllowed;
                showToast(`Maximum quantity limit is ${maxAllowed}`, 'error');
            }

            // If Reselling Session Active, Add Profit
            if(activeResellingSession && activeResellingSession.productId === id) {
                finalPriceToUse = parseInt(finalPriceToUse) + parseInt(activeResellingSession.profit);
                resellerInfo = {
                    resellerPhone: activeResellingSession.resellerPhone,
                    profit: activeResellingSession.profit,
                    linkId: activeResellingSession.linkId
                };
            }

            if(p.hasVariants && Array.isArray(p.variants) && p.variants.length > 0 && v){ 
                const sv = p.variants.find(vr => vr.name === v);
                cid = `${id}_${v}`; 
                cdata = { ...p, price: finalPriceToUse, originalPrice: sv.originalPrice, selectedVariantName: sv.name, quantity: q }; 
            } else {
                if(p.stock < q){ showToast('Out of stock','error'); return; } 
                cid = id; 
                cdata = { ...p, price: finalPriceToUse, quantity: q };
            }   
            
            if(resellerInfo) cdata.reselling = resellerInfo;

            if(userCart[cid]) {
                const newQ = userCart[cid].quantity + q;
                 if (newQ > maxAllowed) {
                    userCart[cid].quantity = maxAllowed;
                    showToast(`Limit reached: Max ${maxAllowed} units allowed`);
                 } else {
                    userCart[cid].quantity = newQ;
                 }
            } else {
                 userCart[cid] = cdata; 
            }   
            
            if(currentUser)await set(ref(db,`users/${currentUser.phone}/cart/${cid}`),userCart[cid]); else{saveCartToStorage(userCart);renderCart();updateBadges();} showToast(`${p.name} added to cart!`);   
        };  
        const updateCartQuantity = async (id,q)=>{if(q<=0)delete userCart[id];else userCart[id].quantity=q; if(currentUser)await set(ref(db,`users/${currentUser.phone}/cart`),userCart); else{saveCartToStorage(userCart);renderCart();updateBadges();}};  
        
        // --- FLIPKART STYLE RENDER CART ---
        const renderCart = () => {   
            const c = document.getElementById('cart-items');
            const s = document.getElementById('cart-summary');
            const items = Object.values(userCart);   
            
            if (items.length === 0) {
                c.innerHTML = '<div style="text-align:center; padding:40px 20px;"><img src="https://rukminim1.flixcart.com/www/800/800/promos/16/05/2019/d438a32e-765a-4d8b-b4a6-520b560971e8.png?q=90" style="width:180px; margin:0 auto;"><h3 style="margin-top:10px;">Your cart is empty!</h3><p style="color:#878787; font-size:12px; margin-bottom:20px;">Add items to it now.</p><button onclick="window.location.hash=\'#home\'" class="btn btn-primary">Shop Now</button></div>'; 
                s.classList.add('d-none'); 
                return;
            } 
            
            s.classList.remove('d-none');   
            
            const cartItemsHTML = items.map(it => { 
                const img = (Array.isArray(it.imageUrls) && it.imageUrls.length > 0) ? it.imageUrls[0] : it.imageUrl; 
                const id = it.selectedVariantName ? `${it.id}_${it.selectedVariantName}` : it.id;
                
                // Calculate Discount Percent for Display
                let discountPercent = 0;
                if(it.originalPrice && it.originalPrice > it.price) {
                    discountPercent = Math.round(((it.originalPrice - it.price) / it.originalPrice) * 100);
                }

                return `
                <div class="fk-cart-card">
                    <div class="fk-item-flex">
                        <div class="fk-img-box">
                            <img src="${img}" alt="${it.name}" loading="lazy" onload="this.classList.add('loaded')">
                        </div>
                        <div class="fk-info-box">
                            <h3 class="fk-title">${it.name}</h3>
                            ${it.selectedVariantName ? `<div class="fk-variant">Option: ${it.selectedVariantName}</div>` : ''}
                            <div class="fk-seller">Seller: DuckShop Assured</div>
                            <div class="fk-price-row">
                                <span class="fk-price-old">${it.originalPrice ? formatCurrency(it.originalPrice) : ''}</span>
                                <span class="fk-price-main">${formatCurrency(it.price)}</span>
                                <span class="fk-discount">${discountPercent > 0 ? discountPercent + '% Off' : ''}</span>
                            </div>
                        </div>
                    </div>
                    <div class="fk-actions-row">
                        <div class="fk-qty-counter">
                            <button class="fk-qty-btn" data-action="decrease-qty" data-id="${id}">-</button>
                            <div class="fk-qty-val">${it.quantity}</div>
                            <button class="fk-qty-btn" data-action="increase-qty" data-id="${id}">+</button>
                        </div>
                        <button class="fk-action-btn" data-action="remove-from-cart" data-id="${id}">Remove</button>
                    </div>
                </div>`; 
            }).join(''); 
            
            c.innerHTML = cartItemsHTML;
            updateCartSummary();   
        };  
        
        const updateCartSummary = () => {   
            const s = document.getElementById('cart-summary'); 
            if (Object.keys(userCart).length === 0) return; 
            
            const sub = Object.values(userCart).reduce((sm, i) => sm + (i.price * i.quantity), 0); 
            const itemsCount = Object.values(userCart).reduce((sm, i) => sm + i.quantity, 0);
            
            // Calculate hypothetical savings (Original - Selling)
            let totalOriginal = Object.values(userCart).reduce((sm, i) => {
                const op = i.originalPrice || i.price;
                return sm + (op * i.quantity);
            }, 0);
            
            const isCheckout = window.location.hash.startsWith('#checkout');
            const showDelivery = isCheckout && isLocationCaptured;
            
            let del = 0;
            if(showDelivery) {
                del = calculatedDeliveryFee;
            }

            let dis = 0;   
            if(appliedDiscount && validDiscounts[appliedDiscount]) {
                const d = validDiscounts[appliedDiscount]; 
                if(d.type === 'percent') dis = Math.min(sub * (d.value / 100), d.max || Infinity); 
                else if(d.type === 'fixed') dis = d.value;
            } else if(appliedDiscount) {
                showToast(`Discount invalid`, 'error'); appliedDiscount = null;
            }   
            
            const grandTotal = sub - dis + del;
            const totalSavings = (totalOriginal - sub) + dis;

            // Check Shop Status for Checkout Button
            const shopState = getShopState();
            let checkoutBtnHtml = `<button id="checkout-btn" class="fk-place-order-btn">Place Order</button>`;
            if(!shopState.isOpen) {
                checkoutBtnHtml = `<button class="fk-place-order-btn" style="background:#ccc;" disabled>Shop Closed</button>`;
            }

            // HTML Structure for Price Details (Flipkart Style)
            s.innerHTML = `
                <div class="fk-price-details">
                    <div class="fk-price-header">Price Details</div>
                    <div class="fk-price-row-detail">
                        <span>Price (${itemsCount} items)</span>
                        <span>${formatCurrency(totalOriginal)}</span>
                    </div>
                    <div class="fk-price-row-detail green">
                        <span>Discount</span>
                        <span> ${formatCurrency(totalOriginal - sub)}</span>
                    </div>
                     ${appliedDiscount ? `
                    <div class="fk-price-row-detail green">
                        <span>Coupon Savings <button class="remove-discount" data-action="remove-discount" style="font-size:10px;">(Remove)</button></span>
                        <span> ${formatCurrency(dis)}</span>
                    </div>` : ''}
                    
                    <div class="fk-total-row">
                        <span>Total Amount</span>
                        <span>${formatCurrency(grandTotal)}</span>
                    </div>
                    <div class="fk-savings-msg">You will save ${formatCurrency(totalSavings)} on this order</div>
                </div>
                
                <div style="background:white; padding:16px; margin-top:10px; margin-bottom:10px;">
                     <div class="discount-form">
                        <input type="text" id="discount-code-input" placeholder="Enter Coupon Code">
                        <button class="btn btn-outline" id="apply-discount-btn">Apply</button>
                    </div>
                </div>

                <div class="fk-sticky-footer">
                    <div>
                        <div style="font-size:18px; font-weight:600;">${formatCurrency(grandTotal)}</div>
                    </div>
                    ${checkoutBtnHtml}
                </div>
            `;
        };  

        // === NEW HELPER FUNCTION TO UPDATE CHECKOUT SUMMARY & WALLET LOGIC ===
        const updateCheckoutSummaryHTML = (subtotal, deliveryFee, grandTotal, locCaptured, distKm) => {
            const checkoutChargesContainer = document.getElementById('checkout-charges-summary');
            if (!checkoutChargesContainer) return; 

            // 1. Update HTML
            let delText = locCaptured ? `${formatCurrency(deliveryFee)}` : "Calculated after detection";
            let distText = locCaptured ? `(${distKm.toFixed(1)} km)` : "";
            
            checkoutChargesContainer.innerHTML = `
                <div class="cart-summary-item"><span>Subtotal:</span><span>${formatCurrency(subtotal)}</span></div>
                <div class="cart-summary-item"><span>Delivery Fee ${distText}:</span><span>${delText}</span></div>
                <div class="cart-summary-item total"><span>Total Payable:</span><span>${formatCurrency(grandTotal)}</span></div>
            `;

            // 2. Handle Wallet Locking Logic
            const walletOption = document.getElementById('payment-wallet');
            const walletBalance = resellerData ? (resellerData.balance || 0) : 0;
            
            if(walletOption) {
                const walletInfo = document.getElementById('wallet-balance-display');
                walletInfo.innerHTML = `Available: <strong>${formatCurrency(walletBalance)}</strong>`;

                if (!locCaptured) {
                    walletOption.classList.add('disabled');
                    walletOption.classList.remove('selected');
                    if(selectedPaymentMethod === 'wallet') {
                        selectedPaymentMethod = 'cod';
                        document.getElementById('payment-cod').classList.add('selected');
                    }
                    walletInfo.innerHTML += ` <span style="color:#f57c00; font-size:0.8rem; display:block;">Detect location to calculate total</span>`;
                } 
                else if (walletBalance < grandTotal) {
                    walletOption.classList.add('disabled');
                    walletOption.classList.remove('selected');
                    if(selectedPaymentMethod === 'wallet') {
                        selectedPaymentMethod = 'cod';
                        document.getElementById('payment-cod').classList.add('selected');
                    }
                    walletInfo.innerHTML += ` <span style="color:red; font-size:0.8rem; display:block;">Insufficient Balance (Need ${formatCurrency(grandTotal)})</span>`;
                } else {
                    walletOption.classList.remove('disabled');
                }
            }
        };
          
        const renderFavourites = ()=>{ 
            const w=document.getElementById('favourites-items'); 
            if(userFavourites.length===0){w.innerHTML='<p class="empty-list-message">Your favourites list is empty.</p>';return;} 
            w.innerHTML=userFavourites.map(id=>{ 
                const p=allProducts.find(pr=>pr.id===id); 
                if(!p)return''; 
                const img=(Array.isArray(p.imageUrls)&&p.imageUrls.length>0)?p.imageUrls[0]:p.imageUrl; 
                
                // FIX: Check for variants to display starting price correctly
                let displayPrice = p.price;
                if(p.hasVariants && p.variants && p.variants.length > 0) {
                    displayPrice = p.variants[0].price;
                }

                return `<div class="list-item wishlist-item-clickable" data-id="${p.id}"><img src="${img}" loading="lazy" onload="this.classList.add('loaded')"><div class="list-item-info"><h3>${p.name}</h3><p>${formatCurrency(displayPrice)}</p></div><div class="list-item-actions"><button class="btn-danger" data-action="remove-from-favourites" data-id="${p.id}"><i class="fas fa-trash"></i></button></div></div>`; 
            }).join(''); 
        };  
          
        /* FLIPKART STYLE ORDER LIST */
        const renderOrders = () => {  
            const container = document.getElementById('order-history'); 
            // Ensures container is clear before re-rendering to prevent "Double Show" issues
            container.innerHTML = ''; 

            if (!currentUser) { container.innerHTML = '<p class="empty-list-message">Please log in to see your orders.</p>'; return; }  
            
            const userOrders = Object.values(allOrders).filter(order => order.userId === currentUser.phone).sort((a, b) => new Date(b.date) - new Date(a.date));  
            
            if (userOrders.length === 0) { container.innerHTML = '<p class="empty-list-message">You have no past orders.</p>'; return; }  
            
            container.innerHTML = userOrders.map(order => {  
                const orderDate = new Date(order.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }); 
                const firstItem = Object.values(order.items)[0];  
                const img = (Array.isArray(firstItem.imageUrls) && firstItem.imageUrls.length > 0) ? firstItem.imageUrls[0] : firstItem.imageUrl;
                
                // Determine Status Color
                let dotClass = 'orange';
                let statusText = order.status;
                if(order.status === 'Delivered') { dotClass = 'green'; statusText = `Delivered on ${orderDate}`; }
                else if(order.status === 'Cancelled') { dotClass = 'red'; statusText = 'Cancelled'; }
                else if(order.status === 'Shipped') { dotClass = 'green'; statusText = `Arriving soon`; }

                return `
                <div class="fk-order-card" data-order-id="${order.id}">
                    <img src="${img}" class="fk-order-img" loading="lazy" onload="this.classList.add('loaded')">
                    <div class="fk-order-info">
                        <div class="fk-order-title">${firstItem.name}</div>
                        <div style="font-size:12px; color:#878787;">${Object.keys(order.items).length > 1 ? `+ ${Object.keys(order.items).length - 1} more items` : ''}</div>
                        <div class="fk-order-status">
                            <span class="status-dot ${dotClass}"></span>
                            <span style="color:#212121; font-weight:500;">${statusText}</span>
                        </div>
                    </div>
                    <div style="align-self:center;">
                         <i class="fas fa-chevron-right" style="color:#878787; font-size:12px;"></i>
                    </div>
                </div>`;  
            }).join('');  
        };  

        // ORIGINAL PREMIUM ORDER DETAIL PAGE RENDERER (RESTORED)
        const renderOrderDetailPage = (orderId) => {  
            const container = document.getElementById('order-detail-page'); 
            const order = allOrders[orderId]; 
            
            if (!order || order.userId !== currentUser.phone) { 
                container.innerHTML = '<div class="container"><p class="empty-list-message">Order not found.</p></div>'; 
                return; 
            }  
            
            const itemsHtml = Object.values(order.items).map(item => { 
                const img = (Array.isArray(item.imageUrls) && item.imageUrls.length > 0) ? item.imageUrls[0] : item.imageUrl; 
                return `<div class="list-item">
                            <img src="${img}" alt="${item.name}" loading="lazy" onload="this.classList.add('loaded')">
                            <div class="list-item-info">
                                <h3>${item.name}</h3>
                                ${item.selectedVariantName ? `<p><small>Variant: ${item.selectedVariantName}</small></p>` : ''}
                                <p><small>Qty: ${item.quantity} &times; ${formatCurrency(item.price)}</small></p>
                            </div>
                            <div class="list-item-actions">
                                <strong>${formatCurrency(item.price * item.quantity)}</strong>
                            </div>
                        </div>`; 
            }).join('');  
            
            const isConfirmed = ['Pending', 'Shipped', 'Delivered'].includes(order.status);
            const isShipped = ['Shipped', 'Delivered'].includes(order.status);
            const isDelivered = order.status === 'Delivered';  
            
            const statusTrackerHtml = order.status === 'Cancelled' ? 
                `<div class="order-detail-card text-center"><h3 style="color: var(--theme-orange);">Order Cancelled</h3></div>` : 
                `<div class="status-tracker">
                    <div class="status-line" style="width: ${isDelivered ? 66.67 : isShipped ? 33.33 : 0}%;"></div>
                    <div class="status-step ${isConfirmed ? 'completed' : ''}">
                        <div class="status-step-icon"><i class="fas fa-check"></i></div>
                        <span class="status-step-label">Confirmed</span>
                    </div>
                    <div class="status-step ${isShipped ? 'completed' : ''}">
                        <div class="status-step-icon"><i class="fas fa-truck"></i></div>
                        <span class="status-step-label">Out for Delivery</span>
                    </div>
                    <div class="status-step ${isDelivered ? 'completed' : ''}">
                        <div class="status-step-icon"><i class="fas fa-box-open"></i></div>
                        <span class="status-step-label">Delivered</span>
                    </div>
                </div>`;  
            
            container.innerHTML = `
                <div class="container">
                    <div class="order-detail-header">
                        <a href="#orders" class="back-btn" style="margin-bottom: 1rem; display: inline-block;"><i class="fas fa-arrow-left"></i> Back to Orders</a>
                        <h2>Order Details</h2>
                        <p><strong>Order ID:</strong> ${generateNumericOrderId(order.id)}</p>
                        <p><strong>Placed on:</strong> ${new Date(order.date).toLocaleDateString()}</p>
                    </div>
                    
                    <div class="order-detail-card">
                        ${statusTrackerHtml}
                    </div>
                    
                    <div class="order-detail-card">
                        <h3>Items Ordered</h3>
                        ${itemsHtml}
                    </div>
                    
                    <div class="order-detail-card order-detail-summary">
                        <h3>Payment Details</h3>
                        <div class="cart-summary-item">
                            <span>Payment Method:</span>
                            <span>${order.paymentMethod === 'cod' ? 'Cash on Delivery' : 'Duck Wallet'}</span>
                        </div>
                        <hr style="border: none; border-top: 1px dashed var(--theme-border); margin: 1rem 0;">
                        <div class="cart-summary-item"><span>Subtotal:</span><span>${formatCurrency(order.subtotal)}</span></div>
                        <div class="cart-summary-item"><span>Delivery Charge:</span><span>${formatCurrency(order.deliveryFee)}</span></div>
                        ${order.discount > 0 ? `<div class="cart-summary-item" style="color: var(--theme-green);"><span>Discount (${order.discountCode || ''}):</span><span>-${formatCurrency(order.discount)}</span></div>` : ''}
                        ${order.walletDeduction > 0 ? `<div class="cart-summary-item" style="color: var(--theme-blue);"><span>Wallet Paid:</span><span>-${formatCurrency(order.walletDeduction)}</span></div>` : ''}
                        <div class="cart-summary-item total"><span>Total Amount:</span><span>${formatCurrency(order.total)}</span></div>
                    </div>
                    
                    <div class="order-detail-card">
                        <h3>Delivery Location</h3>
                        <p><strong>${order.shippingDetails.name}</strong></p>
                        <p>${order.shippingDetails.fullAddress}</p>
                        <p>${order.shippingDetails.city}, ${order.shippingDetails.state} - ${order.shippingDetails.pincode}</p>
                        <p>Phone: ${order.shippingDetails.phone}</p>
                    </div>
                </div>`;  
        };  
          
        const updateBadges = () => { const c=Object.values(userCart).reduce((s,i)=>s+i.quantity,0); if (bottomCartBadge) bottomCartBadge.textContent = c > 0 ? c : ''; if (favouritesBadge) favouritesBadge.textContent = userFavourites.length > 0 ? userFavourites.length : ''; };  
        const getCartFromStorage=()=>JSON.parse(localStorage.getItem('cart'))||{}; const saveCartToStorage=(c)=>localStorage.setItem('cart',JSON.stringify(c)); const getFavouritesFromStorage=()=>JSON.parse(localStorage.getItem('favourites'))||[]; const saveFavouritesToStorage=(w)=>localStorage.setItem('favourites',JSON.stringify(w));  
          
        const toggleFavourite = async (id)=>{ const i=userFavourites.indexOf(id); if(i>-1)userFavourites.splice(i,1); else userFavourites.push(id); if(currentUser){await set(ref(db,`users/${currentUser.phone}/favourites`),userFavourites);}else{saveFavouritesToStorage(userFavourites);renderFavourites();updateBadges();} showToast(i>-1?'Removed from favourites':'Added to favourites'); updateCurrentView(); };  
        const checkSessionOnLoad = async ()=>{ 
            const p=localStorage.getItem('loggedInUserPhone'); 
            if(p){
                const s=await get(ref(db,`users/${p}`)); 
                if(s.exists()){
                    currentUser={phone:p,...s.val()}; 
                    updateUIForAuthState(); 
                    await mergeLocalDataToFirebase(p); 
                    attachUserListeners(p); 
                    loadProfileData(); 
                    checkNotificationStatus();
                } else {
                    handleLogout();
                }
            } else {
                currentUser=null; 
                updateUIForAuthState(); 
                loadLocalData(); 
                renderCart(); 
                renderFavourites(); 
                updateBadges();
                window.location.hash = '#welcome';
            } 
            handleRouting(); 
        };  
        
        const handleAuthCheck = async (phone) => {
            const btn = document.getElementById('auth-check-btn');
            btn.innerHTML = 'Verifying...';
            btn.disabled = true;

            try {
                const snapshot = await get(ref(db, `users/${phone}`));
                verifiedAuthPhone = phone; 
                
                if (snapshot.exists()) {
                    window.location.hash = '#login';
                    document.getElementById('login-phone').value = verifiedAuthPhone;
                    document.getElementById('login-password').focus();
                } else {
                    window.location.hash = '#register';
                    document.getElementById('register-phone').value = verifiedAuthPhone;
                    document.getElementById('register-name').focus();
                }
            } catch (error) {
                showToast("Connection Error", "error");
            } finally {
                btn.innerHTML = 'Continue';
                btn.disabled = false;
            }
        };

        const handleLogin = async (p,pw)=>{ try{ const s=await get(ref(db,`users/${p}`)); if(s.exists()){ const u=s.val(); if(u.password===pw){currentUser={phone:p,...u}; localStorage.setItem('loggedInUserPhone',p); updateUIForAuthState(); await mergeLocalDataToFirebase(p); attachUserListeners(p); loadProfileData(); window.location.hash='#home'; showToast('Logged in!'); requestPermissionAndGetToken(); }else{showToast('Incorrect password','error');}}else{showToast('User not found','error');}}catch(e){showToast('Login error','error');} };  
        
        const handleRegister = async (name, p, pw, confirmPw) => {  
            if(pw !== confirmPw) {
                showToast("Passwords do not match", "error");
                return;
            }
            try {  
                const s = await get(ref(db, `users/${p}`));  
                if (s.exists()) { showToast('Number already registered.', 'error'); } else { const u = { phone: p, password: pw, createdAt: new Date().toISOString(), profile: { name: name } }; await set(ref(db, `users/${p}`), u); currentUser = u; localStorage.setItem('loggedInUserPhone', p); updateUIForAuthState(); await mergeLocalDataToFirebase(p); attachUserListeners(p); loadProfileData(); window.location.hash = '#home'; showToast('Registration successful!'); requestPermissionAndGetToken(); }  
            } catch (e) { showToast('Registration error', 'error'); }  
        };  

        const handleLogout = ()=>{ detachUserListeners(); currentUser=null; resellerData=null; localStorage.removeItem('loggedInUserPhone'); updateUIForAuthState(); loadLocalData(); renderCart(); renderFavourites(); updateBadges(); window.location.hash='#welcome'; showToast('Logged out.'); verifiedAuthPhone = null; };  
        const detachUserListeners = ()=>{Object.values(activeListeners).forEach(l=>{if(l.ref && l.callback){off(l.ref,'value',l.callback);}}); activeListeners={};};  
        const attachUserListeners = (p)=>{ 
            detachUserListeners(); 
            const cr=ref(db,`users/${p}/cart`), cc=onValue(cr,(s)=>{userCart=s.val()||{}; renderCart();updateBadges(); updateCurrentView();}); activeListeners.cart={ref:cr,callback:cc}; 
            const fr=ref(db,`users/${p}/favourites`), fc=onValue(fr,(s)=>{userFavourites=s.val()||[]; renderFavourites();updateCurrentView();updateBadges();}); activeListeners.favourites={ref:fr,callback:fc}; 
            // REMOVED ADDRESS LISTENER
            const ur=ref(db,`used_discounts/${p}`), uc=onValue(ur,(s)=>{userUsedDiscounts=s.val()||{};}); activeListeners.usedDiscounts={ref:ur,callback:uc}; 
            
            const or=ref(db,'orders'), oc=onValue(or,(s)=>{ 
                allOrders=s.val()||{}; 
                creditWalletForDeliveredOrders(allOrders, p);

                const h=window.location.hash||'#home'; 
                if(h.startsWith('#orders'))renderOrders(); 
                else if(h.startsWith('#order')){const p=new URLSearchParams(h.split('?')[1]),o=p.get('id');if(o)renderOrderDetailPage(o);} 
                else if(h.startsWith('#reselling-dashboard')) renderResellingDashboard(); 
            }); 
            activeListeners.orders={ref:or,callback:oc}; 
            
            const rr = ref(db, `resellers/${p}`);
            const rc = onValue(rr, (s) => {
                const profileWalletCard = document.querySelector('.duck-wallet-profile-card');
                const profileWalletOverlay = document.querySelector('.wallet-overlay');
                
                if (s.exists()) {
                    resellerData = s.val();
                    const bal = resellerData.balance || 0;
                    
                    if(document.getElementById('resell-available-balance'))
                         document.getElementById('resell-available-balance').textContent = formatCurrency(bal);

                    if(document.getElementById('wallet-balance-display'))
                         document.getElementById('wallet-balance-display').innerHTML = `Available: <strong>${formatCurrency(bal)}</strong>`;
                    
                    if(profileWalletCard && profileWalletOverlay) {
                        profileWalletCard.classList.remove('blurred');
                        profileWalletOverlay.style.display = 'none';
                        const balanceEl = profileWalletCard.querySelector('.card-balance-amount');
                        if(balanceEl) balanceEl.textContent = formatCurrency(bal);
                    }

                } else {
                    resellerData = null;
                    if(profileWalletCard && profileWalletOverlay) {
                        profileWalletCard.classList.add('blurred');
                        profileWalletOverlay.style.display = 'flex';
                        const balanceEl = profileWalletCard.querySelector('.card-balance-amount');
                        if(balanceEl) balanceEl.textContent = '0.00';
                    }
                }
            });
            activeListeners.reselling = { ref: rr, callback: rc };
        };  
        
        const creditWalletForDeliveredOrders = async (orders, phone) => {
            if (!orders || !phone) return;
            
            const updates = {};
            let hasUpdates = false;
            let totalProfitToAdd = 0;

            Object.keys(orders).forEach(orderId => {
                const o = orders[orderId];
                if (o.resellerId === phone && o.status === 'Delivered' && o.resellerProfit && !o.resellerProfit.credited) {
                    totalProfitToAdd += o.resellerProfit.net;
                    updates[`orders/${orderId}/resellerProfit/credited`] = true;
                    hasUpdates = true;
                }
            });

            if (hasUpdates && totalProfitToAdd > 0) {
                try {
                    const resRef = ref(db, `resellers/${phone}`);
                    const snapshot = await get(resRef);
                    if(snapshot.exists()) {
                        const currentData = snapshot.val();
                        const currentBalance = currentData.balance || 0;
                        const currentTotalEarnings = currentData.totalEarnings || 0;
                        
                        updates[`resellers/${phone}/balance`] = currentBalance + totalProfitToAdd;
                        updates[`resellers/${phone}/totalEarnings`] = currentTotalEarnings + totalProfitToAdd;
                        
                        await update(ref(db), updates);
                        showToast(`${totalProfitToAdd.toFixed(2)} credited to Duck Wallet!`);
                    }
                } catch(e) { console.error("Credit error", e); }
            }
        };

        const updateUIForAuthState = ()=>{ const p=document.querySelectorAll('.protected-route'),a=document.getElementById('auth-link'),ha=document.getElementById('home-auth-link'); if(currentUser){p.forEach(e=>e.classList.remove('d-none')); a.classList.add('d-none'); ha.classList.add('d-none'); }else{p.forEach(e=>e.classList.add('d-none')); a.classList.remove('d-none'); ha.classList.remove('d-none');}};  
        const loadLocalData=()=>{userCart=getCartFromStorage();userFavourites=getFavouritesFromStorage();};  
        const mergeLocalDataToFirebase=async (p)=>{ const lc=getCartFromStorage(),lf=getFavouritesFromStorage();let m=false; if(Object.keys(lc).length>0){m=true; const s=await get(ref(db,`users/${p}/cart`)); const fc=s.val()||{}; Object.keys(lc).forEach(k=>{fc[k]?fc[k].quantity+=lc[k].quantity:fc[k]=lc[k];}); await set(ref(db,`users/${p}/cart`),fc); localStorage.removeItem('cart');} if(lf.length>0){m=true; const s=await get(ref(db,`users/${p}/favourites`)); const ff=s.val()||[]; const mf=[...new Set([...ff,...lf])]; await set(ref(db,`users/${p}/favourites`),mf); localStorage.removeItem('favourites');} if(m)showToast('Guest data merged!'); };  
          
        /* 
           =========================================================
           MULTI-STEP CHECKOUT FUNCTIONS (NEW)
           =========================================================
        */
        
        const renderCheckoutPage = () => {
            // Default to Address Step
            renderCheckoutAddressPage();
        };

        const renderCheckoutAddressPage = () => {
            selectedPaymentMethod = 'cod';
            
            const continueBtn = document.getElementById('address-step-continue-btn');
            
            // Re-init listener for continue button
            continueBtn.onclick = () => {
                if(!isLocationCaptured) {
                    showToast('Please detect location first', 'error');
                    document.getElementById('current-location-section').scrollIntoView({behavior: 'smooth'});
                    return;
                }
                window.location.hash = '#checkout-summary';
            };
        };

        const renderCheckoutSummaryPage = () => {
            if(!isLocationCaptured) {
                window.location.hash = '#checkout-address';
                return;
            }

            const checkoutItemsContainer = document.getElementById('checkout-items-details'); 
            const checkoutChargesContainer = document.getElementById('checkout-charges-summary');
            
            const items = Object.values(userCart); 
            checkoutItemsContainer.innerHTML = items.map(item => { 
                const img = (Array.isArray(item.imageUrls) && item.imageUrls.length > 0) ? item.imageUrls[0] : item.imageUrl; 
                return `<div class="list-item" style="padding: 0.5rem 0; border-bottom: none;"><img src="${img}" style="width: 50px; height: 50px; object-fit: contain; border: 1px solid #e0e0e0; border-radius: 4px;" loading="lazy" onload="this.classList.add('loaded')"><div class="list-item-info" style="text-align: left;"><h3>${item.name}</h3>${item.selectedVariantName ? `<p><small>Option: ${item.selectedVariantName}</small></p>` : ''}<p><small>${item.quantity} x ${formatCurrency(item.price)}</small></p></div></div>`; 
            }).join(''); 
            
            updateCartSummary(); // Refresh calculations (discounts etc)
            
            // Manually trigger the update HTML for this specific container since updateCartSummary does general cart
            const subtotal = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let dis = 0;   
            if(appliedDiscount && validDiscounts[appliedDiscount]) {
                const d = validDiscounts[appliedDiscount]; 
                if(d.type === 'percent') dis = Math.min(subtotal * (d.value / 100), d.max || Infinity); 
                else if(d.type === 'fixed') dis = d.value;
            }
            
            let total = subtotal - dis + calculatedDeliveryFee;
            
            updateCheckoutSummaryHTML(subtotal, calculatedDeliveryFee, total, true, distanceInKm);
            
            document.getElementById('summary-step-continue-btn').onclick = () => {
                window.location.hash = '#checkout-payment';
            };
        };

        const renderCheckoutPaymentPage = () => {
             if(!isLocationCaptured) {
                window.location.hash = '#checkout-address';
                return;
            }
            
            // Payment Logic setup
            const walletBalance = resellerData ? (resellerData.balance || 0) : 0;
            const walletDisplay = document.getElementById('wallet-balance-display');
            const walletOption = document.getElementById('payment-wallet');
            
            walletDisplay.innerHTML = `Available: <strong>${formatCurrency(walletBalance)}</strong>`;
            
            // Recalculate Total for validation
            const sub = Object.values(userCart).reduce((sm, i) => sm + (i.price * i.quantity), 0); 
            let dis = 0;   
            if(appliedDiscount && validDiscounts[appliedDiscount]) {
                const d = validDiscounts[appliedDiscount]; 
                if(d.type === 'percent') dis = Math.min(sub * (d.value / 100), d.max || Infinity); 
                else if(d.type === 'fixed') dis = d.value;
            }
            const grandTotal = sub - dis + calculatedDeliveryFee;

            if (walletBalance < grandTotal) {
                walletOption.classList.add('disabled');
                walletOption.classList.remove('selected');
                selectedPaymentMethod = 'cod';
                document.getElementById('payment-cod').classList.add('selected');
                walletDisplay.innerHTML += ` <span style="color:red; font-size:0.8rem; display:block;">Insufficient Balance</span>`;
            } else {
                walletOption.classList.remove('disabled');
            }
            
            walletOption.onclick = function() {
                if(this.classList.contains('disabled')) return;
                selectedPaymentMethod = 'wallet';
                document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
                this.classList.add('selected');
            };
            
            document.getElementById('payment-cod').onclick = function() {
                selectedPaymentMethod = 'cod';
                document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
                this.classList.add('selected');
            };
            
            // FIXED: Removed duplicate event listener assignment to prevent DOUBLE ORDER
            // const confirmBtn = document.getElementById('final-confirm-order-btn');
            // confirmBtn.onclick = placeOrder; 
        };

        const updateLocationCaptureStatus = () => { const statusDiv = document.getElementById('location-capture-status'); const badge = statusDiv.querySelector('.location-capture-badge'); if (isLocationCaptured) { statusDiv.classList.add('captured'); badge.textContent = 'Captured'; badge.className = 'location-capture-badge captured'; statusDiv.querySelector('p').textContent = 'Location captured successfully!'; } else { statusDiv.classList.remove('captured'); badge.textContent = 'Not Captured'; badge.className = 'location-capture-badge not-captured'; statusDiv.querySelector('p').textContent = 'Current location is required. Please click the button below.'; } };
        const updateConfirmOrderButtonState = () => { 
            // In multi-step, we primarily check at step transitions
            const addressContinue = document.getElementById('address-step-continue-btn');
            if(addressContinue) {
                if(isLocationCaptured) addressContinue.disabled = false;
                else addressContinue.disabled = true;
            }
        };

        const detectAndroidWebView = () => { const userAgent = navigator.userAgent || navigator.vendor || window.opera; return /android/i.test(userAgent) && (/wv/i.test(userAgent) || /Version\/.*Chrome/i.test(userAgent)); };
        const detectCurrentLocation = async () => {
            const button = document.getElementById('detect-location-btn'); const messageDiv = document.getElementById('location-message'); const isWebView = detectAndroidWebView(); if (!navigator.geolocation) { if(messageDiv) messageDiv.innerHTML = '<p style="color:red">Geolocation not supported.</p>'; return; }
            if (button) { button.disabled = true; button.innerHTML = isWebView ? '<i class="fas fa-satellite-dish"></i> Requesting GPS...' : 'Detecting...'; } if (isWebView) { showToast("Requesting System Location...", "notification"); }
            try { const position = await new Promise((resolve, reject) => { navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }); }); const { latitude, longitude } = position.coords; currentDetectedLocation = { latitude, longitude }; const address = await reverseGeocode(latitude, longitude);
                
                isLocationCaptured = true; 
                currentDetectedAddress = {
                     name: currentUser?.profile?.name || 'Current Location',
                     phone: currentUser?.phone || '',
                     fullAddress: address.display_name || `Near ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`,
                     pincode: address.address?.postcode || '799201',
                     city: address.address?.city || 'Khowai',
                     state: address.address?.state || 'Tripura',
                     latitude: latitude,
                     longitude: longitude,
                     isCurrentLocation: true
                };

                // CALCULATE RAW DISTANCE FIRST
                let rawDistance = getDistanceFromLatLonInKm(adminLocation.latitude, adminLocation.longitude, latitude, longitude);
                
                // ==============================================================
                // DYNAMIC DELIVERY CALCULATION APPLIED HERE (UPDATED LOGIC)
                // ==============================================================
                // LOGIC: If real distance > 1.7km, add 1.5km buffer. Otherwise use real distance.
                if (rawDistance > 1.7) {
                    distanceInKm = rawDistance + 1.5;
                } else {
                    distanceInKm = rawDistance;
                }
                
                let cost = distanceInKm * deliveryPerKm;
                if (cost < minDeliveryCharge) cost = minDeliveryCharge;
                calculatedDeliveryFee = Math.ceil(cost); 
                
                updateLocationCaptureStatus(); 
                updateConfirmOrderButtonState(); 
                
                updateCartSummary(); 

                const detectedAddressDiv = document.getElementById('detected-address'); 
                detectedAddressDiv.classList.remove('d-none'); 
                
                detectedAddressDiv.innerHTML = `
                    <h4><i class="fas fa-check-circle"></i> Location Detected</h4>
                    <p><strong>Address:</strong> ${address.display_name || 'Detected'}</p>
                    <p style="font-size:0.9rem;"><a href="https://www.google.com/maps?q=${latitude},${longitude}" target="_blank" style="color:var(--theme-blue); font-weight:600;"><i class="fas fa-map-marked-alt"></i> View on Google Maps</a></p>
                `; 
                showToast(`Location captured! Delivery: ${formatCurrency(calculatedDeliveryFee)}`, 'success'); 
                
            } catch (error) { let errorMsg = isWebView ? (error.code === 1 ? "App Location Permission Denied. Please allow in Android Settings." : "GPS Signal weak or OFF. Please turn on GPS in Quick Settings.") : 'Please allow location access in your browser.'; if(messageDiv) { messageDiv.classList.remove('d-none'); messageDiv.innerHTML = `<p style="color:red; background: #fff; padding: 10px; border-radius: 4px;">${errorMsg}</p>`; } } finally { if (button) { button.disabled = false; button.innerHTML = '<i class="fas fa-location-crosshairs"></i> Detect My Location'; } }
        };
        const reverseGeocode = async (lat, lng) => { try { const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`); if (!response.ok) throw new Error('Geocoding failed'); return await response.json(); } catch (error) { return { display_name: `Near ${lat.toFixed(4)}, ${lng.toFixed(4)}`, address: { postcode: '799201', city: 'Khowai', state: 'Tripura' } }; } };
        
        const placeOrder = async () => {  
            // 1. Check Shop Status
            const shopState = getShopState();
            if(!shopState.isOpen) {
                showToast(shopState.message, 'error');
                return;
            }

            if (!isLocationCaptured) { showToast('Please detect your current location.', 'error'); window.location.hash = '#checkout-address'; return; }
            
            // FIX 1: Prevent Double Clicks / Double Order
            const confirmBtn = document.getElementById('final-confirm-order-btn');
            if(confirmBtn) {
                if(confirmBtn.disabled) return; // Already processing
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            }

            try { 
                const orderItems = {};
                let resellerToCredit = null;
                const subtotal = Object.values(userCart).reduce((s, i) => s + (i.price * i.quantity), 0); 
                const deliveryFee = calculatedDeliveryFee; 
                const grandTotal = subtotal + deliveryFee;

                let walletDeduction = 0;
                let finalTotal = grandTotal;

                if (selectedPaymentMethod === 'wallet') {
                    const currentBalance = resellerData ? (resellerData.balance || 0) : 0;
                    if (currentBalance >= grandTotal) {
                        walletDeduction = grandTotal;
                        finalTotal = 0;
                    } else {
                        showToast('Insufficient wallet balance. Please use COD.', 'error');
                        if(confirmBtn) {
                             confirmBtn.disabled = false;
                             confirmBtn.innerHTML = 'Place Order';
                        }
                        return;
                    }
                }

                for (const cid in userCart) { 
                    const item = userCart[cid]; 
                    const product = allProducts.find(p => p.id === item.id); 
                    if (!product) { showToast(`Product "${item.name}" unavailable.`, 'error'); if(confirmBtn){confirmBtn.disabled = false; confirmBtn.innerHTML = 'Place Order';} return; } 
                    
                    if (item.selectedVariantName) { 
                        const variant = product.variants.find(v => v.name === item.selectedVariantName); 
                        if (!variant || variant.stock < item.quantity) { showToast(`"${item.name}" out of stock.`, 'error'); if(confirmBtn){confirmBtn.disabled = false; confirmBtn.innerHTML = 'Place Order';} return; } 
                    } else if (product.stock < item.quantity) { showToast(`"${item.name}" out of stock.`, 'error'); if(confirmBtn){confirmBtn.disabled = false; confirmBtn.innerHTML = 'Place Order';} return; }
                    
                    orderItems[cid] = item;
                    if(item.reselling) {
                        resellerToCredit = item.reselling;
                    }
                } 
                
                const shippingDetails = currentDetectedAddress; 
            
                let discount = 0; if (appliedDiscount && validDiscounts[appliedDiscount]) { const d = validDiscounts[appliedDiscount]; discount = d.type === 'percent' ? Math.min(subtotal * (d.value/100),d.max||Infinity) : d.value; } 
                
                const orderData = { 
                    id: '', 
                    userId: currentUser.phone, 
                    userPhone: currentUser.phone, 
                    items: orderItems, 
                    subtotal, 
                    discount, 
                    deliveryFee, 
                    walletDeduction, 
                    total: finalTotal, 
                    date: new Date().toISOString(), 
                    status: 'Pending', 
                    shippingDetails, 
                    paymentMethod: selectedPaymentMethod, 
                    discountCode: appliedDiscount || '', 
                    locationCaptured: isLocationCaptured, 
                    detectedLocation: currentDetectedLocation || null, 
                    distanceInKm: distanceInKm 
                };

                const orderRef = push(ref(db, 'orders')); 
                orderData.id = orderRef.key;
                
                const updates = {}; 

                if (walletDeduction > 0) {
                     const newWalletBalance = (resellerData.balance || 0) - walletDeduction;
                     updates[`resellers/${currentUser.phone}/balance`] = newWalletBalance;
                }

                if (resellerToCredit) {
                    orderData.resellerId = resellerToCredit.resellerPhone;
                    let totalProfit = 0;
                     Object.values(orderItems).forEach(item => {
                         if(item.reselling && item.reselling.resellerPhone === resellerToCredit.resellerPhone) {
                             totalProfit += (item.reselling.profit * item.quantity);
                         }
                     });
                    const platformFee = totalProfit * 0.20;
                    const finalCredit = totalProfit - platformFee;
                    
                    orderData.resellerProfit = {
                        gross: totalProfit,
                        fee: platformFee,
                        net: finalCredit,
                        credited: false 
                    };
                }

                updates[`orders/${orderData.id}`] = orderData;
                
                for (const cid in userCart) { const i = userCart[cid], p = allProducts.find(pr => pr.id === i.id); if (i.selectedVariantName) { const vIndex = p.variants.findIndex(v => v.name === i.selectedVariantName); if (vIndex !== -1) updates[`/products/${i.id}/variants/${vIndex}/stock`] = p.variants[vIndex].stock - i.quantity; } else { updates[`/products/${i.id}/stock`] = p.stock - i.quantity; } } 
                
                await update(ref(db), updates); 
                
                if (appliedDiscount) await set(ref(db, `used_discounts/${currentUser.phone}/${appliedDiscount}`), true); 
                await set(ref(db, `users/${currentUser.phone}/cart`), null); 
                
                // FIX 2: Reset Logic for Next Order Refresh
                appliedDiscount = null; 
                isLocationCaptured = false; 
                currentDetectedLocation = null; 
                currentDetectedAddress = null;
                
                // Explicitly clear DOM elements to force refresh on next checkout
                const detectedAddrDiv = document.getElementById('detected-address');
                if(detectedAddrDiv) {
                    detectedAddrDiv.innerHTML = '';
                    detectedAddrDiv.classList.add('d-none');
                }
                const locStatus = document.getElementById('location-capture-status');
                if(locStatus) {
                    locStatus.classList.remove('captured');
                    const badge = locStatus.querySelector('.location-capture-badge');
                    if(badge) {
                        badge.textContent = 'Not Captured';
                        badge.className = 'location-capture-badge not-captured';
                    }
                }

                showToast('Order placed successfully!', 'success'); 
                window.location.hash = '#order-confirmation'; 
                
                // Reset button for future use
                if(confirmBtn) {
                     confirmBtn.disabled = false;
                     confirmBtn.innerHTML = 'Place Order';
                }

            } catch (error) { 
                showToast('Failed to place order: ' + error.message, 'error'); 
                console.error(error); 
                // Re-enable button on error
                if(confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = 'Place Order';
                }
            }  
        };  

        const loadProfileData = async () => { if (!currentUser) return; document.getElementById('profile-phone-display').value = currentUser.phone; const s = await get(ref(db, `users/${currentUser.phone}/profile`)); if (s.exists()) { const p = s.val(); currentUser.profile = p; document.getElementById('profile-name').value = p.name || ''; document.getElementById('profile-email').value = p.email || ''; } };  

        // ==========================================================
        // RESELLING SYSTEM LOGIC
        // ==========================================================

        const renderResellingJoinPage = async () => {
            if(resellerData) {
                window.location.hash = '#reselling-dashboard';
                return;
            }
            if(currentUser) {
                try {
                    const snap = await get(ref(db, `resellers/${currentUser.phone}`));
                    if(snap.exists()) {
                        resellerData = snap.val();
                        window.location.hash = '#reselling-dashboard';
                        return;
                    }
                } catch(e) { console.error(e); }
            }

            document.getElementById('create-reselling-account-btn').onclick = async () => {
                try {
                    const newReseller = {
                        phone: currentUser.phone,
                        joinedAt: new Date().toISOString(),
                        balance: 0,
                        totalEarnings: 0,
                        status: 'active'
                    };
                    await set(ref(db, `resellers/${currentUser.phone}`), newReseller);
                    showToast('Reselling Account Created!');
                    window.location.hash = '#reselling-dashboard';
                } catch(e) {
                    showToast('Error creating account', 'error');
                }
            };
        };

        const renderResellingDashboard = async () => {
             if(!resellerData) { 
                 if(currentUser) {
                     try {
                         const snap = await get(ref(db, `resellers/${currentUser.phone}`));
                         if(snap.exists()) {
                             resellerData = snap.val();
                         } else {
                             window.location.hash = '#reselling-join';
                             return;
                         }
                     } catch(e) { 
                         console.error(e); 
                         return; 
                     }
                 } else {
                     return;
                 }
             }
             
             let totalConfirmedProfit = 0;
             let pendingProfit = 0;
             let confirmedOrdersCount = 0;
             let pendingOrdersCount = 0;
             
             const resellerOrders = Object.values(allOrders).filter(o => o.resellerId === currentUser.phone);
             
             resellerOrders.forEach(o => {
                 if(o.resellerProfit) {
                     if(o.status === 'Delivered') {
                        totalConfirmedProfit += o.resellerProfit.net;
                        confirmedOrdersCount++;
                     } else if (o.status !== 'Cancelled') {
                        pendingProfit += o.resellerProfit.net;
                        pendingOrdersCount++;
                     }
                 }
             });

             const availableBalance = resellerData.balance || 0;

             document.getElementById('resell-total-earnings').textContent = formatCurrency(totalConfirmedProfit);
             document.getElementById('resell-available-balance').textContent = formatCurrency(availableBalance); 
             document.getElementById('resell-pending-balance').textContent = formatCurrency(pendingProfit);
             document.getElementById('resell-confirmed-orders').textContent = confirmedOrdersCount;
             document.getElementById('resell-pending-orders').textContent = pendingOrdersCount;

             const historyContainer = document.getElementById('reselling-history-list');
             
             onValue(ref(db, 'reselling_links'), (snap) => {
                 if(!snap.exists()) {
                     historyContainer.innerHTML = '<p class="empty-list-message">No links generated yet.</p>';
                     return;
                 }
                 
                 const entries = Object.entries(snap.val())
                    .filter(([key, val]) => val.resellerPhone === currentUser.phone)
                    .sort((a,b) => new Date(b[1].createdAt) - new Date(a[1].createdAt));
                    
                 if(entries.length === 0) {
                     historyContainer.innerHTML = '<p class="empty-list-message">No links generated yet.</p>';
                     return;
                 }

                 let html = entries.map(([key, link]) => {
                     const product = allProducts.find(p => p.id === link.productId);
                     if(!product) return `<div class="history-link-card"><p>Product Unavailable</p></div>`;
                     
                     const linkOrdersCount = Object.values(allOrders).filter(o => {
                         return Object.values(o.items).some(item => item.reselling && item.reselling.linkId === key);
                     }).length;
                     
                     const img = (Array.isArray(product.imageUrls) && product.imageUrls.length > 0) ? product.imageUrls[0] : product.imageUrl;

                     return `
                        <div class="history-link-card clickable" onclick="window.location.hash='#reselling-link-details?id=${key}'">
                            <img src="${img}" class="history-link-img">
                            <div class="history-link-info">
                                <div style="font-weight:600; font-size:1rem; margin-bottom:4px;">${product.name}</div>
                                <div style="font-size:0.9rem; color:var(--theme-blue); font-weight:600;">
                                    Orders: ${linkOrdersCount} <i class="fas fa-chevron-right" style="float:right; font-size:0.8rem; margin-top:4px; color:#ccc;"></i>
                                </div>
                            </div>
                        </div>
                     `;
                 }).join('');
                 
                 historyContainer.innerHTML = html;
             });
        };

        const renderResellingLinkDetailsPage = async (linkId) => {
            const container = document.getElementById('reselling-link-details-page');
            container.innerHTML = '<div class="container"><div class="skeleton" style="height:200px"></div></div>'; 

            try {
                const snap = await get(ref(db, `reselling_links/${linkId}`));
                if(!snap.exists()) {
                    container.innerHTML = '<p class="empty-list-message">Link not found.</p>';
                    return;
                }
                const linkData = snap.val();
                const product = allProducts.find(p => p.id === linkData.productId);
                
                if(!product) {
                     container.innerHTML = '<p class="empty-list-message">Product unavailable.</p>';
                     return;
                }

                let totalLinkOrders = 0;
                let totalLinkProfit = 0;

                const linkOrders = Object.values(allOrders).filter(o => {
                     const hasItem = Object.values(o.items).some(item => item.reselling && item.reselling.linkId === linkId);
                     if(hasItem) {
                         Object.values(o.items).forEach(item => {
                             if(item.reselling && item.reselling.linkId === linkId && o.status !== 'Cancelled') {
                                 const gross = item.reselling.profit * item.quantity;
                                 const net = gross - (gross * 0.20);
                                 totalLinkProfit += net;
                             }
                         });
                         totalLinkOrders++;
                     }
                     return hasItem;
                });

                const shareLink = `${window.location.origin}${window.location.pathname}#product?id=${product.id}&r_link=${linkId}`;
                const basePrice = linkData.basePrice || product.price; 
                const profitMargin = linkData.profit;
                const finalPrice = parseInt(basePrice) + parseInt(profitMargin);

                container.innerHTML = `
                    <div class="container">
                        <a href="#reselling-dashboard" class="back-btn" style="display:inline-block; margin-bottom:1rem;"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
                        
                        <div class="link-detail-header">
                            <h2 style="font-size:1.3rem; margin-bottom:1rem;">${product.name}</h2>
                            <div style="display:flex; justify-content:space-around; align-items:center; margin-top:1rem;">
                                <div style="text-align:center;">
                                    <div style="font-size:1.8rem; font-weight:700; color:var(--theme-blue);">${totalLinkOrders}</div>
                                    <div style="font-size:0.8rem; color:var(--theme-secondary-text);">Total Orders</div>
                                </div>
                                <div style="width:1px; height:40px; background:#eee;"></div>
                                <div style="text-align:center;">
                                    <div style="font-size:1.8rem; font-weight:700; color:var(--theme-green);">${formatCurrency(totalLinkProfit)}</div>
                                    <div style="font-size:0.8rem; color:var(--theme-secondary-text);">Total Earned</div>
                                </div>
                            </div>
                        </div>

                        <div class="breakdown-card">
                            <h3 style="margin-bottom:1rem; border-bottom:1px solid #eee; padding-bottom:0.5rem;">Price Breakdown</h3>
                            <div class="breakdown-row">
                                <span>Original Product Price</span>
                                <span>${formatCurrency(basePrice)}</span>
                            </div>
                            <div class="breakdown-row" style="color:var(--theme-green);">
                                <span>Your Profit Margin</span>
                                <span>+${formatCurrency(profitMargin)}</span>
                            </div>
                            <div class="breakdown-row highlight">
                                <span>Total Reselling Price</span>
                                <span>${formatCurrency(finalPrice)}</span>
                            </div>
                        </div>

                        <div class="form-container text-center">
                            <h3>Share this Product</h3>
                             <input type="text" value="${shareLink}" readonly style="width:100%; padding:0.5rem; margin:0.5rem 0; border:1px solid #ddd; border-radius:4px; text-align:center;">
                             <div style="display:flex; gap:10px; margin-top:10px;">
                                <button class="btn btn-outline" style="flex:1" onclick="navigator.clipboard.writeText('${shareLink}').then(()=>showToast('Link Copied!'))">Copy Link</button>
                                <a href="https://wa.me/?text=${encodeURIComponent('Check this out: ' + shareLink)}" target="_blank" class="btn btn-success" style="flex:1">WhatsApp</a>
                             </div>
                        </div>
                    </div>
                `;

            } catch(e) {
                console.error(e);
                container.innerHTML = '<p class="empty-list-message">Error loading details.</p>';
            }
        };

        const renderResellingCreatePage = () => {
             const container = document.getElementById('reselling-create-page');
             
             const processBtn = document.getElementById('reselling-process-link-btn');
             if(processBtn) {
                 const newBtn = processBtn.cloneNode(true);
                 processBtn.parentNode.replaceChild(newBtn, processBtn);
                 
                 newBtn.onclick = () => {
                     const linkVal = document.getElementById('reselling-paste-link-input').value.trim();
                     if(!linkVal) { showToast("Please enter a valid Product ID", "error"); return; }
                     
                     const foundProduct = allProducts.find(p => getShortProductId(p.id).toString() === linkVal);
                     
                     if (foundProduct) {
                         window.location.hash = `#reselling-product-setup?id=${foundProduct.id}`;
                     } else {
                         showToast("Invalid Product ID. Check & try again.", "error");
                     }
                 };
             }
        };

        const renderResellingProductSetup = (id) => {
            const product = allProducts.find(p => p.id === id);
            if(!product) return;
            
            let basePrice = product.price;
            if (product.hasVariants && product.variants && product.variants.length > 0) {
                basePrice = product.variants[0].price;
            }
            if (!basePrice) basePrice = 0;

            const img = (Array.isArray(product.imageUrls) && product.imageUrls.length > 0) ? product.imageUrls[0] : product.imageUrl;
            
            document.getElementById('resell-setup-product-preview').innerHTML = `
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <img src="${img}" style="width: 80px; height: 80px; object-fit: contain; border: 1px solid #eee;">
                    <div>
                        <h4>${product.name}</h4>
                        <p>Base Price: <strong>${formatCurrency(basePrice)}</strong></p>
                    </div>
                </div>
            `;
            
            const profitInput = document.getElementById('resell-profit-input');
            const display = document.getElementById('resell-final-price-display');
            
            if(!profitInput.value) profitInput.value = 10;

            const updateCalc = () => {
                let val = parseInt(profitInput.value);
                if (isNaN(val)) val = 0;
                
                if(val > 100) { 
                    val = 100; 
                    profitInput.value = 100;
                    showToast("Maximum profit is 100", "error");
                }
                
                const total = parseInt(basePrice) + val;
                display.textContent = formatCurrency(total);
            };
            
            profitInput.onkeyup = updateCalc;
            profitInput.onchange = updateCalc;
            profitInput.oninput = updateCalc;
            
            updateCalc();

            document.getElementById('generate-resell-link-btn').onclick = async () => {
                let profit = parseInt(profitInput.value);
                if(isNaN(profit) || profit < 1) {
                    showToast("Minimum profit is 1", "error");
                    return;
                }
                
                const finalPrice = parseInt(basePrice) + profit;
                const linkId = 'r' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                
                const linkData = {
                    productId: product.id,
                    resellerPhone: currentUser.phone,
                    basePrice: basePrice, 
                    profit: profit,
                    finalPrice: finalPrice,
                    createdAt: new Date().toISOString()
                };

                await set(ref(db, `reselling_links/${linkId}`), linkData);
                
                const shareLink = `${window.location.origin}${window.location.pathname}#product?id=${product.id}&r_link=${linkId}`;
                window.location.hash = `#reselling-share?link=${encodeURIComponent(shareLink)}`;
            };
        };

        const renderResellingSharePage = (link) => {
            const inp = document.getElementById('resell-generated-link');
            inp.value = link;
            
            document.getElementById('copy-resell-link-btn').onclick = () => {
                inp.select();
                document.execCommand('copy');
                showToast('Link Copied!');
            };
            
            const waMsg = `Check out this product! Best price: ${link}`;
            document.getElementById('whatsapp-share-btn').href = `https://wa.me/?text=${encodeURIComponent(waMsg)}`;
        };

        const handleIncomingResellingLink = async (linkId) => {
            try {
                const snap = await get(ref(db, `reselling_links/${linkId}`));
                if(snap.exists()) {
                    const data = snap.val();
                    activeResellingSession = {
                        linkId: linkId,
                        ...data
                    };
                    update(ref(db, `resellers/${data.resellerPhone}/totalClicks`), (data.totalClicks || 0) + 1).catch(()=>{});
                    showToast(`Special offer from reseller applied!`);
                }
            } catch(e) { console.error(e); }
        };

        document.addEventListener('DOMContentLoaded', ()=>{ startAppListeners(); checkSessionOnLoad(); const sideMenu = document.getElementById('side-menu'), menuOverlay = document.getElementById('menu-overlay'), homeMenuIcon = document.getElementById('home-menu-icon'); const closeMenu = () => { sideMenu.classList.remove('open'); menuOverlay.classList.remove('active'); }; if (homeMenuIcon) homeMenuIcon.addEventListener('click', (e) => { e.stopPropagation(); sideMenu.classList.add('open'); menuOverlay.classList.add('active'); }); if (menuOverlay) menuOverlay.addEventListener('click', closeMenu); if (sideMenu) sideMenu.addEventListener('click', (e) => { if (e.target.closest('a')) closeMenu(); }); });  

        window.addEventListener('hashchange', handleRouting);  
        document.querySelectorAll('.close-modal-btn').forEach(b=>b.addEventListener('click', ()=>document.querySelector(b.dataset.target).classList.remove('open')));  
        
        document.getElementById('auth-check-form').addEventListener('submit', (e)=>{ e.preventDefault(); handleAuthCheck(e.target['auth-phone'].value); });
        document.getElementById('login-form').addEventListener('submit', (e)=>{e.preventDefault(); handleLogin(e.target['login-phone'].value,e.target['login-password'].value);});  
        document.getElementById('register-form').addEventListener('submit', (e)=>{ e.preventDefault(); handleRegister(e.target['register-name'].value, e.target['register-phone'].value, e.target['register-password'].value, e.target['register-confirm-password'].value); });  
        
        homeSearchTrigger.addEventListener('click', ()=>{window.location.hash='#search';});  
        actualSearchInput.addEventListener('input', handleSearchInput);  
        document.addEventListener('click', (e) => {
            if (e.target.closest('#enable-notifications-btn')) { e.preventDefault(); requestPermissionAndGetToken(); }
            if (e.target.id === 'detect-location-btn' || e.target.closest('#detect-location-btn')) { e.preventDefault(); detectCurrentLocation(); }
            if (e.target.closest('.toast.notification')) { window.location.hash = '#orders'; }
        });
        document.addEventListener('click', (e) => {  
            const actionTarget = e.target.closest('[data-action]');  
            if (actionTarget) {  
                const { action, id } = actionTarget.dataset;  
                switch(action){  
                    case 'add-to-cart-detail': { const p = allProducts.find(p => p.id === id); if (!p) return; let v = null; if (p.hasVariants) { const s = document.getElementById('product-variant-select'); if (!s) return; v = p.variants[s.value].name; } addToCart(id, 1, v); break; }  
                    case 'toggle-favourite': toggleFavourite(id); break;  
                    case 'remove-from-cart': updateCartQuantity(id, 0); break;   
                    case 'remove-from-favourites': toggleFavourite(id); break;  
                    case 'increase-qty': 
                        // ADDED LIMIT CHECK FOR INCREASE
                        const item = userCart[id];
                        const product = allProducts.find(p => p.id === item.id);
                        if(item && product) {
                            let availableStock = product.stock;
                            if(item.selectedVariantName && product.hasVariants) {
                                const variant = product.variants.find(v => v.name === item.selectedVariantName);
                                if(variant) availableStock = variant.stock;
                            }
                            // FLIPKART STYLE LIMIT: Min(Stock, 5)
                            const maxLimit = Math.min(availableStock, 5);
                            if(item.quantity < maxLimit) {
                                updateCartQuantity(id, item.quantity + 1); 
                            } else {
                                showToast(`Maximum quantity limit is ${maxLimit}`, 'error');
                            }
                        }
                        break;   
                    case 'decrease-qty': updateCartQuantity(id, userCart[id].quantity - 1); break;   
                    case 'remove-discount': appliedDiscount = null; updateCartSummary(); showToast('Discount removed'); break;  
                    case 'share-product': {
                         const product = allProducts.find(p => p.id === id);
                         if(product) {
                             const shareLink = `${window.location.origin}${window.location.pathname}#product?id=${id}`;
                             if (navigator.share) {
                                navigator.share({
                                  title: product.name,
                                  text: `Check out ${product.name} on DuckShop!`,
                                  url: shareLink,
                                }).catch(console.error);
                             } else {
                                navigator.clipboard.writeText(shareLink).then(() => {
                                    showToast('Product link copied!');
                                });
                             }
                         }
                         break;
                    }
                    case 'share-product-detail': {
                         const product = allProducts.find(p => p.id === id);
                         if(product) {
                             const shareLink = `${window.location.origin}${window.location.pathname}#product?id=${id}`;
                             if (navigator.share) {
                                navigator.share({
                                  title: product.name,
                                  text: `Check out ${product.name} on DuckShop!`,
                                  url: shareLink,
                                }).catch(console.error);
                             } else {
                                navigator.clipboard.writeText(shareLink).then(() => {
                                    showToast('Product link copied!');
                                });
                             }
                         }
                         break;
                    }
                }  
            } else if (e.target.id === 'final-confirm-order-btn') { placeOrder();  
            } else if (e.target.id === 'checkout-btn') { 
                e.preventDefault(); 
                // Check Shop status before going to checkout
                const shopState = getShopState();
                if(!shopState.isOpen) {
                    showToast(shopState.message, 'error');
                    return;
                }
                if (!currentUser) { showToast('Log in to checkout', 'error'); window.location.hash = '#auth'; return; } window.location.hash = '#checkout-address';  
            } else if (e.target.id === 'apply-discount-btn') { const i = document.getElementById('discount-code-input'); if (!i) return; const c = i.value.trim().toUpperCase(); if (!c) { showToast('Enter code', 'error'); return; } if (!currentUser) { showToast('Log in to use discounts', 'error'); window.location.hash = '#auth'; return; } if (userUsedDiscounts[c]) { showToast('Code already used', 'error'); return; } if (validDiscounts[c]) { appliedDiscount = c; updateCartSummary(); showToast('Discount applied!'); } else { showToast('Invalid code', 'error'); }  
            } else if (e.target.closest('#logout-link')) { e.preventDefault(); handleLogout();  
            } else { const card = e.target.closest('.product-card, .category-card, .wishlist-item-clickable, .home-category-item, .order-card, .fk-order-card'); if (card && !e.target.closest('[data-action]')) { if (card.matches('.product-card, .wishlist-item-clickable')) window.location.hash = `#product?id=${card.dataset.id}`; else if (card.matches('.category-card, .home-category-item')) window.location.hash = `#category?id=${card.dataset.categoryId}&name=${encodeURIComponent(card.dataset.categoryName)}`; else if (card.matches('.order-card, .fk-order-card')) window.location.hash = `#order?id=${card.dataset.orderId}`; } }  
        });  

        document.getElementById('profile-form').addEventListener('submit', async (e) => { e.preventDefault(); if (!currentUser) return; try { const p = { name: e.target['profile-name'].value, email: e.target['profile-email'].value }; await update(ref(db, `users/${currentUser.phone}/profile`), p); currentUser.profile = p; showToast('Profile updated!'); } catch (e) { showToast('Update failed.', 'error'); } });  
          
        document.getElementById('find-account-form').addEventListener('submit', async (e) => {  
            e.preventDefault(); const phone = e.target['find-account-phone'].value;  
            if (!phone || phone.length !== 10) { showToast('Please enter a valid 10-digit number.', 'error'); return; }  
            try { const userSnap = await get(ref(db, `users/${phone}`)); if (userSnap.exists()) { passwordRecoveryUserPhone = phone; const userData = userSnap.val(); const userName = userData.profile?.name || `User: ${phone}`; document.getElementById('found-account-name').textContent = userName; document.getElementById('found-account-details').classList.remove('d-none'); } else { showToast('No account found with this number.', 'error'); document.getElementById('found-account-details').classList.add('d-none'); } } catch (err) { showToast('An error occurred while searching.', 'error'); }  
        });  

        document.getElementById('old-password-form').addEventListener('submit', async (e) => { e.preventDefault(); const oldPassInput = document.getElementById('old-password'); const oldPass = oldPassInput.value; let targetUserPhone = passwordRecoveryUserPhone || (currentUser ? currentUser.phone : null); let targetUserPassword = null; if (!targetUserPhone) { showToast('Session expired. Please start over.', 'error'); window.location.hash = '#auth'; return; } if (passwordRecoveryUserPhone) { const userSnap = await get(ref(db, `users/${targetUserPhone}`)); if (userSnap.exists()) { targetUserPassword = userSnap.val().password; } } else if (currentUser) { targetUserPassword = currentUser.password; } if (oldPass === targetUserPassword) { window.location.hash = '#new-password'; oldPassInput.value = ''; } else { showToast('Incorrect old password.', 'error'); } });  
        document.getElementById('new-password-form').addEventListener('submit', async (e) => { e.preventDefault(); const newPassInput = document.getElementById('new-password'); const confirmPassInput = document.getElementById('confirm-password'); const newPass = newPassInput.value; let targetUserPhone = passwordRecoveryUserPhone || (currentUser ? currentUser.phone : null); if (!targetUserPhone) { showToast('Session expired. Please start over.', 'error'); window.location.hash = '#auth'; return; } if (newPass.length < 1) { showToast('Password cannot be empty.', 'error'); return; } if (newPass !== confirmPassInput.value) { showToast('Passwords do not match.', 'error'); return; } try { await set(ref(db, `users/${targetUserPhone}/password`), newPass); if (currentUser && currentUser.phone === targetUserPhone) { currentUser.password = newPass; } showToast('Password changed successfully!', 'success'); newPassInput.value = ''; confirmPassInput.value = ''; if (passwordRecoveryUserPhone) { passwordRecoveryUserPhone = null; window.location.hash = '#auth'; } else { window.location.hash = '#profile'; } } catch (err) { showToast('Failed to change password.', 'error'); } });  
    </script>

</body>  
</html>